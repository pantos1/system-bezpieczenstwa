\documentclass[a4paper,11pt,twoside]{article}
\let\tempmargin\oddsidemargin
\let\oddsidemargin\evensidemargin
\let\evensidemargin\tempmargin
\reversemarginpar
\renewcommand{\familydefault}{\sfdefault}
\addtolength{\hoffset}{-1.54cm}
\setlength{\oddsidemargin}{2cm}
\setlength{\textwidth}{16cm}

\addtolength{\voffset}{-1in}
\setlength{\topmargin}{1.5cm}
\setlength{\headheight}{5mm}
\setlength{\headsep}{5mm}
\setlength{\textheight}{247mm}
\setlength{\footskip}{1cm}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{polski}
\usepackage{listings}
\usepackage{graphicx} 
\usepackage{color}
\usepackage{helvet}
\usepackage{courier}
\usepackage{pdfpages}
\usepackage{multirow}
\usepackage{hyperref}
\usepackage{float}
\usepackage{textgreek}
\usepackage{longtable}
\usepackage[font={small}]{caption}
\renewcommand*{\tablename}{Tabela}
\renewcommand*{\figurename}{Rys.} 
\renewcommand{\baselinestretch}{1.15} 

\usepackage{fancyhdr}
\fancypagestyle{plain}{
\fancyhead{}
\cfoot{}
\fancyfoot[LE, RO]{\thepage}}
\renewcommand{\headrulewidth}{0pt}

\pagestyle{plain}

\usepackage{tocloft}
\makeatletter
\renewcommand*\@seccntformat[1]{\csname the#1\endcsname.\enspace}
\makeatother
\renewcommand{\cftsecaftersnum}{.}
\renewcommand{\cftsubsecaftersnum}{.}
\renewcommand{\cftsubsubsecaftersnum}{.}
\renewcommand{\cftparaaftersnum}{.}
\renewcommand{\cftsubparaaftersnum}{.}

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{ 
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}; should come as last argument
  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  %deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  %frame=single,	                   % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  morekeywords={*,self},            % if you want to add more keywords to the set
  numbers=none,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=2,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},     % string literal style
  tabsize=2,	                   % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}
\lstdefinelanguage{JavaScript}{
  keywords={async, await, break, case, catch, const, continue, debugger, default, delete, do, else, finally, for, function, if, in, instanceof, let, new, return, switch, this, throw, try, typeof, var, void, while, with},
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]",
  sensitive=true
}

\begin{document}

\includepdf[pages=-, fitpaper=true, offset=1.5cm -2.5cm]{title.pdf}
\null
\thispagestyle{empty}
\newpage

\begin{center}
{\huge System bezpieczeństwa z dostępem sieciowym}
\end{center}

\vspace*{\fill}

\begin{center}
\textbf{Streszczenie}
\end{center}

\noindent
Celem pracy jest stworzenie systemu bezpieczeństwa opartego o komputer jednopłytkowy z~systemem Linux. Podstawowym zadaniem projektowanego systemu jest realizacja monitoringu wizyjnego przez kamery internetowe dołączone do gniazd USB (ang. \textit{Universal Serial Bus}) komputera. Ponadto system ma realizować nadzór otwarcia drzwi lub okien przez dołączone do komputera czujniki stykowe oraz pomiary temperatury i wilgotności względnej powietrza przy użyciu czujników warunków środowiskowych. System zrealizowano przy użyciu platformy Raspberry Pi 3B. Przygotowano program w języku Python, którego zadaniem jest cyklicznie wykonywanie zdjęć oraz odczytywanie stanu czujników. Do przechowywania uzyskanych wyników zaprojektowano relacyjną bazę danych stworzoną przy użyciu systemu zarządzania MySQL. 

Dostęp do zgromadzonych danych zapewnia interfejs użytkownika oparty o stronę WWW umieszczoną na wbudowanym serwerze. Komunikację między klientem (przeglądarką internetową) a serwerem zrealizowano przez żądania protokołu HTTP w technice AJAX (ang. \textit{Asynchronous JavaScript and XML}). Interfejs użytkownika umożliwia dostęp do ostatnio wykonanych zdjęć, archiwum oraz panelu administracyjnego ustawień. Skuteczność działania uruchomionego systemu potwierdzono w~szeregu wykonanych testów.

\vspace{11pt}
\noindent
\textbf{Słowa kluczowe:} monitoring wizyjny, komputer jednopłytkowy, Raspberry Pi, Linux, kamery USB, czujniki stykowe, czujniki warunków środowiskowych, I2C, serwer HTTP, strona WWW

\newpage
\null
\thispagestyle{empty}
\newpage

\thispagestyle{empty}
\begin{center}
{\huge Security system with web access}
\end{center}

\vspace*{\fill}

\begin{center}
\textbf{Abstract}
\end{center}

\noindent
The aim of this thesis is to design a security system using single-board computer with Linux operating system. The system's primary objective is conducting video surveillance through web cameras connected to the \textit{Universal Serial Bus} (USB) ports of the computer. Moreover, the system monitors the opening of the the doors or windows through reed switches and measures temperature and relative humidity using enviromental sensors. The system was designed using the Raspberry Pi 3B platform. A Python program was developed to periodically take photographs and perform measurements. A MySQL relational database was designed to store the results of measurements.

The access to the data is possible through the user’s interface on the website hosted on the webserver. The communication between the client (web browser) and the server is accomplished with \textit{Hypertext Transfer Protocol} (HTTP) protocol in \textit{Asynchronous JavaScript and XML} (AJAX) technique. The user’s interface displays current and past photographs and allows access to the settings panel. The correct system's operation was proved in the conducted tests.

\vspace{11pt}
\noindent
\textbf{Keywords:} video surveillance, single-board computer, Raspberry Pi, Linux, USB cameras, reed switches, environmental sensors, I2C, web server, website 
\newpage

\null
\thispagestyle{empty}
\newpage

\includepdf[pages=1, offset=2cm -2.5cm]{oswiadczenie.pdf}

\null
\thispagestyle{empty}
\newpage

\tableofcontents
\setcounter{tocdepth}{2}
\newpage

\section{Wstęp teoretyczny}

\subsection{Współczesne systemy monitoringu i bezpieczeństwa}
Gwałtowny rozwój technologii wytwarzania matryc CMOS stosowanych w kamerach cyfrowych sprawił, że systemy monitoringu wizyjnego umożliwiają rejestrację obrazu o wysokiej rozdzielczości. Jednocześnie cena tych kamer jest na tyle niewysoka, że są one dostępne nie tylko dla projektantów kompleksowych systemów bezpieczeństwa w obiektach przemysłowych, ale również dla osób chcących zadbać o bezpieczeństwo domu. Z drugiej strony, powszechny dostęp do szerokopasmowego Internetu oraz technologii bezprzewodowych sprawił, że  instalacja systemów bezpieczeństwa nie wymaga już sporej ingerencji w infrastrukturę budynku. Rutery bezprzewodowe i punkty dostępowe wchodzące w skład sieci LAN (ang. \textit{Local Area Network}) zapewniają możliwość bezprzewodowej komunikacji większości urządzeń wchodzących w skład systemu monitoringu.

Z tych powodów w systemach monitoringu wizyjnego coraz częściej stosowane są kamery IP (ang. \textit{Internet Protocol}) łączące się przewodowo lub bezprzewodowo z siecią LAN lub Internet. Ich zaletą, w porównaniu do systemów wykorzystujących technologię HD-CVI (ang. \textit{High Definition Composite Video Interface}), jest brak konieczności stosowania rejestratora oraz możliwość bezpośredniego dołączenia do sieci komputerowej. Kamery te często wyposażone są w diody podczerwone, które umożliwiają prowadzenie nadzoru również nocą. Rejestrowane dane są zapisywane we wbudowanej pamięci wewnętrznej lub w umieszczonej w czytniku karcie SD (ang. \textit{Secure Digital}). Do wielu kamer dołączone jest też oprogramowanie, które umożliwia podgląd obrazu z kamery na komputerze lub urządzeniu mobilnym. Dzięki swojej uniwersalności kamery IP są wykorzystywane zarówno w domach, jak i w rozbudowanych systemach bezpieczeństwa, w których monitoring wizyjny jest jedną z funkcjonalności \cite{komputer_świat}\cite{kamery-ip}.

Nowoczesne systemy bezpieczeństwa bardzo często oparte są o tradycyjne systemy alarmowe, w których centrala nadzorująca zbiera dane np. z czujników ruchu, i sygnalizuje alarm w przypadku wykrycia intruza. Dzięki rozwojowi mikrokomputerów, obecnie system ten może być rozbudowany o część informatyczną, która dodatkowo udostępnia dane z monitoringu wizyjnego realizowanego przy pomocy kamer. W najbardziej rozbudowanych systemach tego typu mikrokomputer lub dedykowane sterowniki kontrolują również elementy automatyki domowej \cite{monitoring}. Mogą być to np. siłowniki opuszczające rolety przeciwwłamaniowe czy regulatory natężenia oświetlenia. Tak skonstruowany system wpisuje się już w ideę "inteligentnego domu".

\subsection{Koncepcja "inteligentnego domu"}
Idea inteligentnego domu (ang. \textit{smart house}) wywodzi się z dążenia do automatyzacji sterowania urządzeniami i systemami w budynkach. Pierwsze tego typu budynki były wyposażone w rozproszone, proste układy odpowiadające za jedno zadanie, np. dostosowywanie temperatury pomieszczeń. Obecnie dąży się do stworzenia w inteligentnym budynku zintegrowanego systemu, który można podzielić na 3 bloki funkcjonalne: zarządzania energią, bezpieczeństwem i~kontrolą dostępu oraz automatyką \cite{inteligentny_dom}.

Inteligentny dom może być więc wyposażony w systemy, które będą optymalizowały zużycie energii w budynku np. przez sterowanie ogrzewaniem domu. Z punktu widzenia bezpieczeństwa kluczowe są kwestie: kontroli składu powietrza, np. w postaci czujki dymu czy szkodliwych gazów, takich jak tlenek węgla(II), oraz kontroli dostępu, która może być realizowana przez monitoring wizyjny i systemy alarmowe. Zarządzenie automatyką domową w inteligentnym domu może polegać np. na sterowaniu roletami przeciwwłamaniowymi. System może mieć utworzoną regułę mówiącą o automatycznym opuszczeniu rolet o określonej godzinie lub po zadziałaniu czujnika zmierzchu \cite{inteligentny_dom}. Zarządzanie komfortem przebywania w pomieszczeniach może być zrealizowane np. przez utrzymywanie odpowiedniej temperatury i jakości powietrza. W budynkach wyposażonych w wentylację mechaniczną może to polegać na jej automatycznym uruchomieniu w momencie przekroczenia temperatury granicznej lub po wykryciu konieczności dostarczenia świeżego powietrza. Inteligentne budynki umożliwiają również regulację natężenia oświetlenia w domu oraz tworzenie tzw. scen świetlnych -- zestawu ustawień natężenia i~barwy światła poszczególnych lamp \cite{inteligentny_dom}.

Ważnym aspektem systemu zarządzającego inteligentnym domem jest również możliwość sterowania systemem na odległość, np. przez sieć Internet. Stawia to wymóg posiadania wydajnego i zabezpieczonego interfejsu, przez który użytkownik będzie miał dostęp do stanu budynku i możliwość zdalnej kontroli nad domową automatyką. Pozwala to ograniczyć niepokój o pozostawione mienie, np. w czasie dłuższego wyjazdu. Związane są z tym bardziej potrzeby leżące u podstaw koncepcji inteligentnego domu -- poprawa komfortu życia przez automatyczne zarządzanie budynkiem oraz zwiększenie poczucia bezpieczeństwa dzięki kontroli dostępu. 

\subsection{Motywacje i cel pracy}
Opisane wcześniej systemy zarządzania inteligentnymi budynkami oferują bardzo duże możliwości, ale jedną z ich wad jest wysoki koszt wykonania. Mogą być więc ograniczeniem dla osób chcących poprawić bezpieczeństwo swojego domu, ale niedysponujących odpowiednimi środkami. Przykładowo, koszt jednej kamery IP to ok. 400 zł \cite{komputer_świat}. Ponadto funkcjonalność komercyjnych systemów jest z reguły ograniczona do pewnego zakresu funkcji przewidzianych przez producenta i użytkownik nie ma możliwości ich rozbudowy. Gdyby jednak zastąpić kamery IP kamerami internetowymi korzystającymi z magistrali USB (ang. \textit{Universal Serial Bus}), możliwe byłoby istotne zmniejszenie kosztu monitoringu. Konieczna byłaby jednak wówczas platforma z odpowiednim oprogramowaniem, która sprawowałaby nadzór przy użyciu tego rodzaju kamer. 

Niniejsza praca ma na celu stworzenie domowego systemu bezpieczeństwa, który będzie realizował funkcje monitoringu wizyjnego oraz kontroli dostępu wraz z pomiarem warunków środowiskowych wpływających na komfort przebywania w pomieszczaniach. System ten powinien umożliwiać sieciowy dostęp do zebranych danych. Dzięki temu po podłączeniu go do domowej sieci oraz do sieci Internet możliwy będzie zdalny nadzór nad budynkiem. 

To zadanie wymaga integracji wielu obszarów elektroniki i informatyki: od wykonania prototypu sprzętu, przez właściwą obsługę programową dołączonych urządzeń, aż po technologie sieciowe związane z zapewnieniem dostępu do danych. Jednocześnie stwarza to okazję do poznania wielu nowoczesnych technologii dzięki różnorodnemu zakresowi zadań do wykonania. Ponadto wykonany system będzie mógł być użyty w praktyce w warunkach domowych i w~przyszłości w miarę potrzeb rozbudowany o kolejne funkcje.



\newpage
\section{Architektura systemu}

\subsection{Wymagania techniczne i funkcjonalne}
Projektowany system bezpieczeństwa powinien łączyć funkcję monitoringu wizyjnego z możliwością kontroli otwarcia drzwi i okien oraz pomiaru warunków środowiskowych. Monitoring powinien być zrealizowany przez kamery USB ze względu na ich atrakcyjną cenę i dostępność. System powinien być skalowalny i umożliwiać rozbudowę o dodatkowe kamery i czujniki, co odpowiada np. rozszerzeniu monitorowanego obszaru o dodatkowe pomieszczenia. Dane zebrane przez system należy udostępniać przez graficzny interfejs użytkownika w postaci strony WWW. Dołączenie systemu do sieci domowej LAN (ang. \textit{Local Area Network}) i wprowadzenie odpowiednich ustawień w panelu administracyjnym rutera (udostępnianie portów, NAT) umożliwi dostęp do strony WWW systemu z dowolnego miejsca przez Internet.

System powinien być zrealizowany w postaci komputera jednopłytkowego z systemem Linux, na którym będzie działał serwer WWW. Odpowiada on za dostęp do strony WWW i zebranych danych. Kontrolę otwarcia drzwi i okien można zrealizować poprzez czujniki stykowe, które należy podłączyć do wyprowadzeń GPIO komputera. Jako czujniki stykowe będzie można również wykorzystać specjalizowane czujniki dla systemów alarmowych np. czujniki ruchu, zalania wodą, detektory dymu i gazu. Dostępne na rynku zintegrowane czujniki warunków środowiskowych (np. temperatury i wilgotności) wymagają obsługi magistrali (np. I2C czy OneWire). Komputer powinien być wyposażony w gniazda USB, do których będą podłączone kamery. Monitoring przy pomocy kamer nie musi być prowadzony w postaci ciągłego nagrania, które wymaga bardzo dużej pojemności pamięci. Wystarczające będzie okresowe wykonywanie zdjęć oraz dodatkowo wyzwalanie zdjęcia w przypadku otwarcia drzwi lub okna -- zadziałania czujnika stykowego przypisanego do odpowiedniej kamery. Większość funkcji systemu jest wprawdzie możliwa do zrealizowania na prostszej platformie (np. Arduino), jednak jak pokazały ostatnie badania \cite{arduino-wlamania}, jest ona podatna na włamania i ataki sieciowe. Zastosowanie systemu Linux umożliwi osiągnięcie większego bezpieczeństwa, a także skalowalności systemu. 

Interfejs użytkownika musi prezentować aktualny stan systemu i umożliwiać dostęp do ostatnio wykonanych zdjęć, odczytów z czujników środowiskowych oraz stanu czujników stykowych (otwarty/zamknięty). Ponadto użytkownik powinien mieć dostęp do przeszłych zdjęć i~pomiarów zebranych w archiwum. Historia pomiarów z systemu powinna być również dostępna w formie eksportowanej listy np. w formacie \textit{csv}. Użytkownik powinien mieć również możliwość dokonania zmian ustawień systemu przez panel administracyjny. Może on umożliwiać np. włączenie wysyłania powiadomień e-mail w przypadku otwarcia czujnika.

Dane zebrane w systemie z kamer i czujników powinny być więc zapisane w systemie tak, by umożliwić do nich dostęp dla serwera, na którym będzie działać strona WWW. Pomiary wykonywane przez system powinny być zapisywane wraz z datą i godziną ich wykonania. Dostęp do tych danych powinien być niezależny od programu zapisującego wyniki pomiarów i prowadzącego monitoring.

Podsumowując, wymagania techniczne stojące przed systemem to:
\begin{itemize}
\item wykorzystanie komputera jednopłytkowego,
\item użycie systemu Linux,
\item użycie serwera WWW,
\item obsługa wielu kamer USB,
\item obsługa wielu dwustanowych czujników stykowych poprzez wyprowadzenia GPIO,
\item obsługa wielu czujników środowiskowych korzystających np. z I2C lub OneWire,
\item możliwość połączenia z Internetem poprzez sieć Ethernet lub Wi-Fi.
\end{itemize}

Wymagania funkcjonalne systemu to:
\begin{itemize}
\item dostęp do stanu systemu poprzez stronę WWW,
\item dostęp do archiwalnych stanów systemu,
\item możliwość eksportu listy pomiarów i zdarzeń do pliku (np. w formacie \textit{csv}),
\item dostęp do ustawień systemu poprzez interfejs użytkownika,
\item wysyłanie powiadomień e-mail w przypadku otwarcia czujnika,
\item automatyczne wykonywanie zdjęcia po otwarciu czujnika.
\end{itemize}

Na podstawie powyższych wymagań opracowana została architektura systemu, którą przedstawiono na rysunku \ref{fig: architektura}. Zostanie ona omówiona w dalszych podrozdziałach.
\begin{figure}[h]
\begin{center}
\includegraphics[width=\linewidth]{architektura.png}
\caption{Architektura systemu bezpieczeństwa.}
\label{fig: architektura}
\end{center}
\end{figure}


\subsection{Przegląd dostępnych platform}
Jednym z najbardziej popularnych komputerów jednopłytkowych jest platforma Raspberry Pi rozwijana przez Raspberry Pi Foundation jako narzędzie edukacyjne do nauczania programowania i elektroniki. Wokół tego projektu zebrała się duża grupa amatorów i entuzjastów dzielących się swoimi projektami. Jednym z konkurentów platformy Raspberry Pi jest komputer jednopłytkowy BeagleBone rozwijany przez firmę Texas Instruments, również zgodnie z filozofią \textit{open-hardware} -- sprzętu o otwartym dostępie do źródła i projektów. Oba komputery oparte są o procesory ARM Cortex w formie \textit{System On Chip} -- układu scalonego zawierającego w~jednej obudowie procesor wraz z układami pamięci, peryferiami i przetwornikami analogowo-cyfrowymi i cyfrowo-analogowymi. Oba komputery umożliwiają zainstalowanie na nich dystrybucji systemu Linux. Najnowszymi modelami w momencie rozpoczęcia projektu (marzec 2017 roku) były Raspberry Pi Model 3B oraz BeagleBone Black. Porównanie obu komputerów przedstawiono w tabeli \ref{porównanieSBC}.
\begin{table}[h]
\centering
\caption{Porównanie specyfikacji technicznej Raspberry Pi 3B i BeagleBone Black} 
\small
\begin{tabular}{lll}
\hline \noalign{\vskip 2mm}
                         & Raspberry Pi 3B & BeagleBone Black \\ \hline \noalign{\vskip 2mm}
Rok wydania              & 2016            & 2013             \\
CPU                      & ARM Cortex-A53  & ARM Cortex-A8    \\
Liczba rdzeni            & 4               & 1                \\
Częstotliwość taktowania & 1,2 GHz         & 1 GHz            \\
RAM                      & 1 GB LPDDR2     & 512 MB DDR3L     \\
Liczb gniazd USB         & 4               & 1                \\
WLAN                     & b/g/n           & brak             \\
Ethernet                 & 10/100          & 10/100           \\
I2C                      & Tak             & Tak              \\
Liczba wyprowadzeń GPIO  & 40              & 66               \\
Maksymalny pobór mocy 	 & 3 W             & 2,3 W            \\ \hline
\end{tabular}
\caption*{Źródła: \cite{rpi} \cite{bb_black} \cite{porownanie_wiki}}
\label{porównanieSBC}
\end{table}

Przewagą komputera Raspberry Pi 3B jest szybszy procesor o większej liczbie rdzeni, co~pozwala na równoległe wykonywanie większej liczby wątków, oraz większa pojemność pamięci RAM. Ponadto ma on możliwość podłączenia zarówno do sieci przewodowej (Ethernet) jak i~bezprzewodowej (WLAN). Może być to przewagą w przypadku, gdy system miałby być zainstalowany z daleka od rutera. Komputer BeagleBone Black ma niższą wartość poboru mocy oraz więcej wyprowadzeń GPIO. Na każdy czujnik stykowy będzie jednak potrzebne jedno wyprowadzenie GPIO oraz podłączenie do masy, zatem 40 wyprowadzeń Raspberry Pi 3B z pewnością będzie wystarczające. Z tych powodów o projektowanego systemu wybrano platformę Raspberry Pi 3B.

Wśród dostępnych dystrybucji systemu Linux na Raspberry Pi są m.in. Raspbian (domyślna dystrybucja oparta o Debian) i Ubuntu Mate. W projekcie zostanie użyty system Raspbian, ponieważ jest on uniwersalny i spełnia wszystkie stawiane wymogi -- obsługę wyprowadzeń GPIO, magistrali I2C oraz możliwość działania jako serwer WWW (np. przy użyciu Apache). System Raspbian posiada również interfejs graficzny, co może być przydatną cechą w przypadku, gdyby konieczna była bezpośrednia interwencja administratora systemu z pominięciem bazującego na stronie WWW interfejsu użytkownika.

\subsection{Czujniki warunków środowiskowych}
Wymogiem technicznym wobec systemu jest również obsługa czujników warunków środowiskowych. Najważniejszymi parametrami, które należy zmierzyć w warunkach domowych są temperatura i wilgotność względna powietrza. Wpływają one na jakość powietrza w pomieszczeniach, odczuwalny poziom komfortu oraz na poziom zachorowań wśród domowników. Badania wykazały związek między wilgotnością względną w domu i pracy oraz liczbą dni spędzonych na zwolnieniu lekarskim. Zbyt niska lub zbyt wysoka wilgotność powietrza w pomieszczeniach prowadzi do zwiększenia przypadków zachorowań na choroby układu oddechowego\cite{zachorowania}\cite{klimat}. 

Przykładowymi czujnikami temperatury i wilgotności dostępnymi na rynku są Adafruit SHT31, Adafruit Si7021 oraz Grove TH02. Są to czujniki umieszczone na płytkach \textit{breakout-board}, które posiadają wyprowadzenia linii I2C, masy oraz zasilania. Porównanie specyfikacji czujników znajduje się w tabeli \ref{czujniki_temp}.

\begin{table}[h]
\centering
\caption{Porównanie specyfikacji technicznej czujników temperatury i wilgotności}
\small
\begin{tabular}{lllllll}
\hline \noalign{\vskip 2mm}
       & \multicolumn{2}{c}{Temperatura} & \multicolumn{2}{c}{Wilgotność} &          \\ \cline{2-5} \noalign{\vskip 2mm}
       & Zakres pomiarowy  & Dokładność  & Zakres pomiarowy  & Dokładność & Cena     \\ \hline \noalign{\vskip 2mm}
SHT31  & $-$40 -- 125 $^\circ$C      & $\pm$ 0,3 $^\circ$C    & 0 -- 100\% RH      & $\pm$ 2 \%RH    & 79,80 zł \\
Si7021 & $-$10 -- 85 $^\circ$C       & $\pm$ 0,4 $^\circ$C    & 0 -- 80\% RH       & $\pm$ 3 \%RH    & 39,70 zł \\
TH02   & $-$40 -- 85 $^\circ$C         & $\pm$ 0,5 $^\circ$C    & 0 -- 80\% RH       & $\pm$ 4,5 \%RH                  & 54,00 zł \\
\hline
\end{tabular}
\caption*{Źródła: \cite{czujnik_temp} \cite{sht31} \cite{th02} (ceny za sztukę: \url{www.botland.com.pl}).}
\label{czujniki_temp}
\end{table}

Na podstawie danych przedstawionych w tabeli \ref{czujniki_temp} wybrano czujnik Si7021 jako użyty w~projekcie czujnik środowiskowy. Zapewnia on pomiar temperatury i wilgotności względnej w zakresie wartości panujących w~warunkach pokojowych oraz ma najniższą cenę. Przewagą czujnika SHT31 była możliwość zmiany adresu I2C przez podłączenie wyprowadzenia adresowego do stanu wysokiego lub niskiego. Byłoby to jednak rozwiązanie możliwe do zastosowania przy użyciu najwyżej dwóch czujników w systemie. 

\subsection{Czujniki stykowe}
Magnetyczne czujniki zbliżeniowe mogą być użyte do określenia pozycji drzwi lub okien i tym samym realizować nad nimi nadzór. Czujniki te posiadają dwa stany -- zamknięty i otwarty. W~systemie zostały użyte czujniki zbliżeniowe MC-38 składające się z kontaktronu i magnesu. Obwód kontaktronu jest domyślnie otwarty, a po zbliżeniu magnesu następuje jego zamknięcie i przepływ prądu. Do realizacji pracy wybrano ten czujnik ze względu na łatwość montażu -- czujnik posiada taśmę samoprzylepną i otwory na śruby montażowe. Zamiast kontaktronów możliwe będzie również dołączenie innych czujników dwustanowych stosowanych powszechnie w systemach alarmowych, np. czujników ruchu, zalania wodą, detektorów dymu i gazu.

\subsection{Kamery cyfrowe}
Kamery USB zastosowane w systemie mają pozwolić na realizację domowego monitoringu wizyjnego niedużym kosztem. Ich uniwersalność pozwala również wykorzystać je w innych domowych zastosowaniach np. jako kamerę do rozmów przez komunikatory internetowe takie jak Skype czy Google Hangouts. W projektowanym systemie zadaniem kamer będzie cykliczne wykonywanie zdjęć. Celem powinno być znalezienie złotego środka między jakością zdjęć wykonywanych przez kamery i ich ceną. Jakość powinna być na tyle dobra, by zdjęcie umożliwiło identyfikację ewentualnego intruza. Koszt jest kategorią bardziej subiektywną, ale kamera USB powinna być konkurencyjna cenowo wobec kamer IP. Koszt typowej kamery IP wynosi ok. 400 zł \cite{komputer_świat}.

W systemie zastosowano dwie kamery z różnego przedziału cenowego. Kamera Titanum Onyx posiada matrycę CMOS, która umożliwia wykonywanie zdjęć o rozdzielczości do 5 megapikseli przy zastosowaniu interpolacji. Co ważne, kamera ta jest kompatybilna z UVC (\textit{USB Video Class}) -- sterownikiem wbudowanym w system Linux. Kamera posiada również przełącznik włączający 3 diody LED, które mogą być przydatne w przypadku wykonywania zdjęć nocnych. Koszt tej kamery to ok. 50 zł. Drugą zastosowaną kamerą jest Creative VFO 790, która posiada matrycę wykonującą zdjęcia w rozdzielczości HD 720p (1280x720 pikseli). Jest ona również kompatybilna z UVC. Optyka kamery jest stałoogniskowa w przeciwieństwie do kamery Titanum Onyx. Koszt tej kamery to ok. 110 zł.

\subsection{Projekt części sprzętowej systemu}
Połączenie między komputerem Raspberry Pi 3B a dołączonymi czujnika zrealizowano na prototypowej płytce stykowej. Umożliwia ona tworzenie prostych układów bez konieczności lutowania połączeń. Połączenia między płytką prototypową a wyprowadzeniami GPIO Raspberry Pi są wykonane przez ekspander wyprowadzeń ProtoPi Plus.

W systemie zostały zastosowane magnetyczne czujniki zbliżeniowe MC-38. Kontaktron został podłączony do wyprowadzenia GPIO poprzez z użyciem wbudowanego rezystora ściągającego do masy (ang. \textit{pull-down}) oraz napięcia zasilania (3,3 V). Gdy kontaktron i magnes są zbliżone, obwód jest zamknięty i na wyprowadzeniu pojawia się stan wysoki. W przypadku oddalenia czujników i otwarcia obwodu na wyprowadzeniu pojawia się stan niski poprzez rezystor ściągający do masy. Na rysunku \ref{fig: kontaktron} został przedstawiony schemat podłączenia czujnika stykowego do platformy Raspberry Pi (z pominięciem ekspandera ProtoPi Plus).
\begin{figure}[h]
\includegraphics[width=0.5\linewidth]{kontaktron.png}
\includegraphics[width=0.5\linewidth]{kontaktron_zamkniety.png}
\caption{Schemat podłączenia czujnika MC-38 w przypadku oddalonego (a) i zbliżonego (b) magnesu.}
\label{fig: kontaktron}
\end{figure}

Wymogiem wobec systemu jest również obsługa wielu kamer i czujników, w tym czujników temperatury i wilgotności poprzez magistralę I2C. Adres I2C wybranych do projektu czujników Si 7021 jest stały i wynosi 0x40. Nie mają one możliwości programowej lub sprzętowej zmiany adresu. Oznacza to, że do jednej magistrali mógłby być podłączony bezpośrednio tylko jeden czujnik. Podłączenie większej liczby czujników o tym samym adresie doprowadziłoby do kolizji i sytuacji, w której nie można jednoznacznie określić, z którego czujnika został odczytany wynik pomiaru. Rozwiązaniem tego problemu jest zastosowanie multipleksera I2C. Multiplekser zadziała jak przełącznik, który pozwoli na komunikację z jednym czujnikiem wybranym w danej chwili. Przykładem takiego układu jest TCA 9548A firmy Adafruit. Pozwala on na podłączenie do 8 urządzeń korzystających ze wspólnej magistrali I2C.

Multiplekser TCA 9548A jest podłączony do wyprowadzeń GPIO2 i GPIO3 w Raspberry Pi, które mogą być aktywowane jako odpowiednio: linia SDA i SCL magistrali I2C. Ponadto wyprowadzenia GPIO2 i GPIO3 są podłączone przez wbudowane rezystory podciągające do napięcia zasilania 3,3 V\cite{rpi_schematic}, co jest zgodne z zaleceniami podanymi w karcie katalogowej multipleksera \cite{multiplekser}. Multiplekser jest zasilany z wyprowadzenia 3,3 V platformy Raspberry Pi i podłączony do jej masy. Wyprowadzenia adresowe A2, A1 i A0 są również podłączone do masy, co oznacza, że adres I2C multipleksera jest ustawiony na 0x70. Nieużywane wyprowadzenie $\overline{\mathsf{RESET}}$ jest z kolei podłączone do zasilania poprzez rezystor podciągajacy, który ogranicza pobór prądu.

Czujniki Si7021 są przyłączone do kanałów SDx i SCx multipleksera, gdzie x jest numerem kanału od 0 do 7. W karcie katalogowej czujnika podany jest typowy schemat przyłączenia, w~którym użyte są rezystory 10 k\textOmega\hspace{0.2em} podciągające  linie SDA i SCL do napięcia zasilania. Producent multipleksera TCA 9548A podaje z kolei w karcie katalogowej wzór \ref{pullup} pozwalający na wyznaczenie minimalnej wartości rezystorów podciągających \cite{multiplekser}. Napięcie $\mathsf{V_{DPU}}$ jest napięciem linii sygnałowych, które jest równe napięciu zasilania $\mathsf{V_{CC}}$. Napięcie $\mathsf{V_{OL(max)}}$ to maksymalne napięcie wyjściowe, a prąd $\mathsf{I_{OL}}$ to prąd wyjściowy czujnika. Obie wartości są podane w karcie katalogowej czujnika Si7021 \cite{czujnik_temp}. Rezystancję minimalną rezystora podciągającego można wyznaczyć ze wzoru:

\begin{equation} \label{pullup}
R_{p(min)} = \frac{V_{DPU} - V_{OL(max)}}{I_{OL}} = \frac{3,3 V - 0,6 V}{2,5 mA} = 1,08 k\Omega  
\end{equation} 

Im większa rezystancja rezystora podciągającego, tym mniejszy pobór prądu. Rezystor podciągający tworzy jednak wraz z pojemnością magistrali $\mathsf{C_{b}}$ filtr dolnoprzepustowy RC. W~przypadku długich przewodów połączeniowych jego stała czasowa nie może być na tyle duża, że~zbocza zostaną rozciągnięte w czasie tak, że ich czas narastania przekroczy wymagania czasowe magistrali. Pojemność linii magistrali jest w~ogólnym przypadku trudna do przewidzenia, więc rezystancja powinna być zbliżona do minimalnej wymaganej. W~ramach projektowanego systemu użyte więc zostały rezystory podciągające 2,2 k\textOmega. Rysunek \ref{fig: i2c_schemat} przedstawia schemat połączeń między komputerem Raspberry Pi a multiplekserem TCA 9548A i~dwoma czujnikami Si7021. Przedstawiono poglądowo tylko dwa czujniki, ale system może być rozbudowany o~dodatkowe czujniki. Przetestowano działanie systemu przy maksymalnie 2 czujnikach, jednak multiplekser posiada w sumie 8 kanałów, do których można dołączyć urządzenia komunikujące się przy użyciu magistrali I2C.

\begin{figure}[h]
\includegraphics[width=\linewidth]{i2c.png}
\caption{Schemat podłączenia multipleksera TCA9548A i czujników Si7021.}
\label{fig: i2c_schemat}
\end{figure}

Podłączenie większej liczby kamer USB do portów Raspberry Pi może spowodować chwilowe przekroczenie dopuszczalnego poboru mocy z gniazd USB. Rozwiązaniem tego problemu jest użycie aktywnego rozgałęziacza (ang. \textit{hub}) USB z zewnętrznym zasilaniem. Zwiększa on jednocześnie zasięg podłączonych przewodowo kamer. Należy uważać jednak, by rozgałęziacz nie zasilał wstecznie (ang. \textit{backfeed}) komputera Raspberry Pi, ponieważ grozi to uszkodzeniem układu. Z tego powodu w projekcie użyto dedykowanego rozgałęziacza firmy The Pi Hut. Na rysunku \ref{fig: prototyp} przedstawiono zdjęcie prototypu sprzętowej części systemu składającego się z komputera Raspberry Pi 3B z dołączonym rozgałęziaczem i kamerami USB, płytki stykowej z dołączonymi do ekspandera wyprowadzeń GPIO czujnikami typu Si7021, multiplekserem TCA9548A i czujnika stykowymi.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.9\linewidth]{prototyp.jpg}
\caption{Wykonany prototyp systemu}
\label{fig: prototyp}
\end{center}
\end{figure}


\newpage
\section{Obsługa kamer i czujników}
Do napisania programu obsługującego czujniki i kamery wybrano język Python, ponieważ umożliwia on, poprzez wiele dostępnych modułów, wysokopoziomową obsługę wyprowadzeń GPIO, magistrali I2C oraz kamer USB. Ponadto istnieje dla niego wiele pakietów pozwalających na łatwą komunikację z bazą danych, która będzie miejscem przechowywania wyników pomiarów. Program w języku Python jest też odpowiedzialny za wysłanie powiadomień e-mail przez serwer SMTP Google. Na potrzeby projektu zostało stworzone konto w usłudze Gmail, przez które będą wysyłanie powiadomienia. 

Zadaniem programu nadzor.py jest cyklicznie wykonywanie pomiarów, odczytów i zdjęć oraz zapis uzyskanych wyników do bazy danych. Potrzebne jest narzędzie, które pozwoli okresowo wykonywać funkcje w ramach jednego programu. Wewnątrz języka Python istnieją mechanizmy (moduł \texttt{sched}), które umożliwiają wykonywanie zadań po minięciu pewnego czasu lub zaplanowanie ich do wykonania o konkretnej porze. Wykorzystanie tego modułu wymagałoby jednak ponownego zaplanowania zadania po każdym jego wykonaniu. Modułem, który umożliwia dokonanie tego w prostszy sposób, jest biblioteka \texttt{schedule}. Jest ona przeznaczona do planowania cyklicznego wykonywania zadań. Przykładowe wywołanie szeregowania przy użyciu biblioteki \texttt{schedule} przedstawiono poniżej:
\begin{lstlisting} [language=Python]
schedule.every(kamera.czestotliwosc_zdjecia).seconds.do(grupa.zrob_zdjecie)
\end{lstlisting}
Jako argument \texttt{every()} podawana jest częstotliwość wykonywania zadania, następnie podawane są jednostki oraz nazwa uruchamianej funkcji jako argument \texttt{do()}.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.5\linewidth]{Grupa.png}
\caption{Diagram UML klasy Grupa}
\label{fig: Grupa}
\end{center}
\end{figure}

Rysunek \ref{fig: Grupa} przedstawia strukturę klasy Grupa. Skrótem \textit{m} oznaczone są metody klasy, a \textit{f} - atrybuty. Działanie poszczególnych metod zostało opisane w dalszych podrozdziałach. 

Program jest napisany przy użyciu metodyki obiektowej. Takie podejście pozwala powiązać czujnik z kamerą, która będzie wykonywała zdjęcia w przypadku zmiany jego stanu. Klasa Grupa reprezentuje czujnik i kamerę oraz dodatkowo przypisany do nich czujnik temperatury. Zawiera ona metody, które wykonują zdjęcie, pomiar temperatury i wilgotności oraz odczyt stanu wyprowadzenia GPIO, do którego jest dołączony czujnik stykowy. Zarządza ona również wysłaniem wiadomości e-mail z powiadomieniem w przypadku zmiany stanu czujnika.

\subsection{Obsługa kamer USB}
Kamery USB są obsługiwane przez metodę \texttt{wyslij{\_}email}. Do samego wykonywania zdjęć użyta jest aplikacja \texttt{fswebcam}. Jest to samodzielny program pozwalający na pobieranie zdjęć z kamer USB podłączonych do komputera z systemem typu Linux. Program ten pozwala na~wykonanie zdjęcia z określonej kamery, zdefiniowane rozdzielczości zdjęcia oraz umieszczenie na~zdjęciu podpisu z bieżącą datą i godziną. 

Wywołanie programu \texttt{fswebcam} z poziomu programu w języku Python wymaga użycia modułu \texttt{subprocessing}. Daje on możliwość otwierania programów w osobnych procesach. W tym przypadku użyta została klasa \texttt{Popen} z tego modułu, otwierająca nowy podproces. Klasa ta jest dostępna zarówno w wersji języka Python 2 jak i 3. Tworząc obiekt klasy, należy przekazać do niego listę składającą się z nazwy programu, który chcemy uruchomić i jego argumentów. Dodatkowo można określić, czy i gdzie kierować informacje ze standardowych strumieni wejścia/wyjścia procesu:

\begin{lstlisting} [language=Python]
proces = Popen(["fswebcam", "-q", "-d/dev/video0", "-r 640x480", "/var/www/html/img/2018-05-24 22:32:10.jpg"], stdout=PIPE, stderr=PIPE)
\end{lstlisting}

Użytymi argumentami programu \texttt{fswebcam} w powyższym przykładowym wywołaniu są:
\begin{itemize}
\item \texttt{-r} -- rozdzielczość , 
\item \texttt{-d} -- nazwa wirtualnego węzła kamery,
\item \texttt{-q} -- tryb cichy,
\item ścieżka, gdzie ma być zapisany plik z wykonanym zdjęciem.
\end{itemize}
Standardowe strumienie wyjścia i błędów są przekierowane do obiektów \texttt{pipe}, dzięki czemu ich wartość będzie można następnie odczytać. Program \texttt{fswebcam} domyślnie przekierowuje wszystkie komunikaty do strumienia błędów. Użycie trybu cichego zapewnia, że w strumieniu błędów znajdzie się jedynie informacja o błędach.

Zdjęcie jest zapisywane w formacie JPG w rozdzielczości 640x480 pikseli. Jest to maksymalna możliwa rozdzielczość zastosowanej kamery Titanum Onyx. Kolejnym argumentem jest nazwa wirtualnego węzła kamery (ang. \textit{virtual device node}) \cite{dev_video}. Jest to plik, który system Linux tworzy podczas uruchomienia i który jest przypisany do konkretnego urządzenia. Plik ten jest przechowywany w folderze \texttt{/dev}. Dzięki użyciu wirtualnego węzła możliwe jest wskazanie konkretnej kamery do wykonania zdjęcia. Zdjęcie jest zapisywane w miejscu wskazanym przez atrybut klasy Grupa o nazwie sciezka. Do przekazywanej do programu ścieżki dołączana jest nazwa zdjęcia w postaci daty zaplanowania jego wykonania. Format daty to "'rok-miesiąc-dzień godzina:minuta:sekunda"' i stanowi unikalny identyfikator zdjęcia. Jest to możliwe, ponieważ w~jednej chwili czasu działa wyłącznie jedno wywołanie funkcji \texttt{wyslij{\_}zdjecie()}.

Po wywołaniu procesu funkcja oczekuje na jego wykonanie i odbiera informacje ze strumienia wyjścia i błędów przy pomocy metody \texttt{communicate()}. Jeśli zawartość strumienia błędów nie jest pusta, podniesiony jest wyjątek \texttt{IOError}. Obsługa wyjątku polega na zapisie wartości pustej (\texttt{None}) do zmiennej \texttt{nazwa}, która zostanie użyta do stworzenia nowego wpisu w bazie danych. Poprawnie wykonane zdjęcie jest więc oznaczane nazwą pliku ze zdjęciem, a~niepoprawne -- wartością pustą.
\subsection{Obsługa czujników podłączonych do magistrali I2C}
\subsubsection{Komunikacja z multiplekserem TCA9548A}
Multiplekser TCA9548A umożliwia przyłączenie do 8 urządzeń korzystających ze wspólnej magistrali I2C. Użyte czujniki temperatury i wilgotności Si 7021 posiadają taki sam adres, więc multiplekser powinien być skonfigurowany do zestawienia komunikacji z każdym z nich osobno. Aktywacja pojedynczego kanału odbywa się poprzez przesłanie do multipleksera 8-bitowego słowa odpowiadającego numerowi kanału. Słowo to tworzone jest przez ustawienie bitu o pozycji równej numerowi aktywowanego kanału jako 1. Pozostałe pola powinny być ustawione jako 0. Operację tą wykonuje pomocnicza funkcja \texttt{kanal}, która zwraca 8-bitowe słowo odpowiadające numerowi kanału. Definicja słowa sterującego została pokazana w tabeli \ref{command_byte}. Po wysłaniu przez I2C tak skonstruowanego słowa i znaku STOP kanał jest aktywowany. Dalsze komendy dla magistrali I2C można już adresować, używając adresu czujnika temperatury.
\begin{table}[h]
\centering
\caption{Definicja słowa sterującego}
\small
\begin{tabular}{|llllllll|l|}
\hline
\multicolumn{8}{|l|}{Bity rejestru sterującego}                                                                                                                                                                                                                                                                                                                                                & \multicolumn{1}{c|}{\multirow{2}{*}{Działanie}}                              \\ \cline{1-8}
B7                                          & B6                                            & B5                                            & B4                                            & B3                                            & B2                                            & B1                                            & \multicolumn{1}{l}{B0}                       & \multicolumn{1}{|c|}{}                                                        \\ \hline 
X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & \begin{tabular}[c]{@{}l@{}}Kanał 0 nieaktywny\\ Kanał 0 aktywny\end{tabular} \\ \hline
X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 1 nieaktywny\\ Kanał 1 aktywny\end{tabular} \\ \hline
X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 2 nieaktywny\\ Kanał 2 aktywny\end{tabular} \\ \hline
X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 3 nieaktywny\\ Kanał 3 aktywny\end{tabular} \\ \hline
X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 4 nieaktywny\\ Kanał 4 aktywny\end{tabular} \\ \hline
X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 5 nieaktywny\\ Kanał 5 aktywny\end{tabular} \\ \hline
X                                             & \begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 6 nieaktywny\\ Kanał 6 aktywny\end{tabular} \\ \hline
\begin{tabular}[c]{@{}l@{}}0\\ 1\end{tabular} & X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & X                                             & \begin{tabular}[c]{@{}l@{}}Kanał 7 nieaktywny\\ Kanał 7 aktywny\end{tabular} \\ \hline
\end{tabular}
\caption*{Źródło: \cite{multiplekser}}
\label{command_byte}
\end{table}

\subsubsection{Komunikacja z czujnikiem Si7021}
Komunikacja z czujnikiem Si7021 odbywa się przez magistralę I2C. Pierwszą komendą, którą należy wysłać do czujnika, jest komenda wykonania pomiaru wilgotności względnej. W dokumentacji czujnika opisane są dwie metody pomiaru - Hold Master Mode oraz No Hold Master Mode. Ich porównanie zostało przedstawione na rysunku \ref{fig: metody_pomiaru}. Kolorem białym są oznaczone komendy i dane wysyłane przez urządzenie nadrzędne (ang. \textit{master}), a szarym przez urządzenie podrzędne (ang. \textit{slave}). W pierwszej z nich urządzenie nadrzędne wysyła żądanie pomiaru (\textit{Measure Cmd}). Po potwierdzeniu odbioru wysyłane jest żądanie odczytu (\textit{R}). Urządzenie podrzędne potwierdza otrzymanie żądania i dokonuje pomiaru. Wymaga to zastosowania rozciągania zegara (ang. \textit{clock stretching}), które polega na utrzymywaniu przez urządzenie podrzędne linii zegarowej SCK w stanie niskim aż do momentu zakończenia pomiaru i wpisaniu jego wyniku do rejestru. Wynik pomiaru składa się z~dwóch bajtów, które należy odebrać w~jednej transakcji. Ostatecznie komunikacja kończy się poprzez wystawienie znaku STOP (\textit{P}). Drugi tryb pomiaru (No Hold Master Mode) różni się tym, że po wysłaniu kodu pomiaru (0xF5) oraz żądania odczytu urządzenie nie potwierdza odbioru aż do momentu zakończenia pomiaru. Następnie należy odczytać dwubajtowy wynik pomiaru z rejestru czujnika.

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.8\linewidth]{Si7021_pomiar.png}
\caption{Porównanie sekwencji komend I2C do wykonania pomiaru czujnikiem Si7021. Źródło: \cite{czujnik_temp}}
\label{fig: metody_pomiaru}
\end{center}
\end{figure}

Do programowej komunikacji przez I2C potrzebna była odpowiednia biblioteka. Pierwszym zastosowanym modułem był moduł \texttt{python-smbus}. Korzysta on ze sterownika wbudowanego w jądro systemu Linux. Do przeprowadzenia pomiaru w trybie Hold Master Mode można użyć funkcji \texttt{i2c{\_}smbus{\_}read{\_}word{\_}data()} lub \texttt{i2c{\_}smbus{\_}read{\_}i2c{\_}block{\_}data()}. Obie funkcje są zgodne z przedstawioną powyżej sekwencją pomiaru, lecz różnią się liczbą odebranych bajtów. Pierwsza funkcja odbiera dokładnie dwa bajty, a druga odbiera bajty z urządzenia do momentu zakończenia komunikacji przez urządzenie podrzędne\cite{smbus}. Próba przeprowadzenia pomiaru przy ich użyciu zakończyła się błędem o kodzie \texttt{io errno5}. Wynikał on z tego, że pakiet \texttt{python-smbus} obsługuje magistralę I2C zgodnie ze standardem SMBus -- rozszerzeniem I2C. Posiada on bardziej ścisłe reguły dotyczące czasu trwania transakcji na magistrali. Procedura pomiaru No Hold Master Mode polega na przesłaniu do urządzenia kodu pomiaru (0xE5), uśpieniu programu na czas wykonania pomiaru, a następnie odczycie wyników. W składni obu wymienionych funkcji pakietu \texttt{python-smbus} odczyt danych z urządzenia poprzedzony jest przesłaniem do niego 8-bitowego słowa. Oznacza to, że nie jest możliwe przy ich pomocy tej części procedury, która polega na wyłącznie odczycie wyników pomiaru. Inna dostępna funkcja odczytu \texttt{i2c{\_}smbus{\_}read{\_}byte()} dokonuje co prawda wyłącznie odczytu danych, ale odbiera tylko jeden bajt danych. Dwukrotne wysłanie żądania odczytu przy pomocy tej funkcji prowadzi do dwukrotnego odczytania pierwszego bajtu pomiaru. Z tych powodów moduł \texttt{python-smbus} nie mógł zostać wykorzystany do obsługi czujnika Si7021. 

Innym pakietem umożliwiającym komunikację przez magistralę I2C jest moduł \texttt{pigpio}. Umożliwia on obsługę wyprowadzeń GPIO na platformie Raspberry Pi w tym również tych, które są skonfigurowane jako magistrala I2C. Opiera on swoje działanie na bibliotece napisanej w języku C. Przed rozpoczęciem działania pakietu konieczne jest uruchomienie programu \texttt{pidpiod}. Jest to demon -- program działający w tle bez interakcji z użytkownikiem. Musi on działać, zanim wywołany zostanie program \texttt{nadzor.py}. Można to zapewnić, korzystając z narzędzia \texttt{cron}. Wpis do jego tabeli z wywołaniem programu \texttt{pigpiod} poprzedzony atrybutem \texttt{@reboot} umieszczony przed podobnym wpisem programu \texttt{nadzor.py} zapewnia, że program zostanie uruchomiony za każdym razem, gdy uruchamiany będzie system operacyjny.

Pierwszym krokiem jest stworzenie obiektu klasy \texttt{pigpio.pi}. Obiekt ten jest przechowywany jako atrybut \textit{i2c} klasy Grupa. Następnie konieczne jest otwarcie komunikacji z urządzeniem i zwrócenie identyfikatora, który będzie używany do wysyłania żądań do urządzeń. Funkcje tego modułu umożliwiają przeprowadzenie pomiaru wilgotności względnej w trybie \textit{No Hold Master Mode}. W pierwszej kolejności wysyłana jest 8-bitowa komenda pomiaru przy pomocy funkcji \texttt{i2c{\_}write{\_}byte()}. Realizuje ona sekwencję pomiaru do momentu potwierdzenia odbioru komendy przez urządzenie podrzędne. Następnie urządzenie oczekuje znaku powtórzonego startu (\textit{Sr}). Dopuszczalne jest jednak również przesłanie znaku STOP i zakończenie komunikacji.

Następnie program jest usypiany na czas 0.05s przy pomocy komendy \texttt{time.sleep()}. Jest to wartość większa niż najdłuższy czas konwersji pomiaru wilgotności względnej podany w karcie katalogowej czujnika Si 7021.\cite{czujnik_temp} W tym czasie wykonywany jest pomiar i można przejść do tej części procedury, która składa się z wysłaniu bitu odczytu (\textit{R}) i odebrania dwóch bajtów wyniku pomiaru. Można to zrealizować poprzez funkcję \texttt{i2c{\_}read{\_}device()}\cite{i2c_read_device}. Funkcja zwraca liczbę odczytanych bajtów oraz odczytane bajty w formie tablicy. Bajty te można następnie wykorzystać do obliczenia wilgotności względnej na podstawie wzoru (\ref{RH}) z karty katalogowej\cite{czujnik_temp}. ${Kod_{RH}}$ oznacza tablicę bajtów, do której wpisano wynik pomiaru.
\begin{equation} \label{RH}
\%RH = \frac{(Kod_{RH}[0] * 256 + Kod_{RH}[1]) * 125}{65536} - 6  
\end{equation}

Czujnik Si 7021 wykonuje pomiar temperatury w ramach procedury wyznaczenia wilgotności względnej. Wynik tego pomiaru jest przechowywany w urządzeniu. Można go odczytać, wysyłając komendę o kodzie 0xE0. Całą transakcję można zrealizować przy użyciu funkcji \texttt{i2c{\_}read{\_}i2c{\_}block{\_}data} bez obawy o rozciąganie zegara, ponieważ nie ma potrzeby oczekiwania na wykonanie pomiaru temperatury. Dwa bajty wyniku pomiaru są zapisane do tablicy i użyte do obliczenia wartości temperatury na \cite{czujnik_temp}:
\begin{equation} \label{Temperatura}
Temperatura ({^\circ}C) = \frac{(Kod_{temp}[0] * 256 + Kod_{temp}[1]) * 175,72}{65536} - 46,85  
\end{equation}

Obsługa wyjątków w komunikacji przy użyciu magistrali I2C jest przeprowadzona przez wypisanie do konsoli komunikatu o typie urządzenia, dla którego nastąpił błąd (multiplekser albo czujnik). W takim wypadku wartościom temperatury i wilgotności są przypisywane wartości \texttt{None}. Są one następnie zapisane w bazie danych. Jeżeli natomiast nie wystąpiły błędy, w~bazie danych zapisywane są obliczone wartości temperatury i wilgotności.

\subsection{Obsługa czujników stykowych}
Korzystanie z wyprowadzeń GPIO w języku Python na komputerze Raspberry Pi jest możliwe przy użyciu pakietu \texttt{RPi.GPIO}. Umożliwia on odczyt stanu wyprowadzeń. Konfiguracja obsługi GPIO rozpoczyna się od określenia sposobu numeracji wyprowadzeń. Dostępne są dwie możliwości: GPIO.BOARD oraz GPIO.BCM. Pierwszy odnosi się do fizycznej lokalizacji wyprowadzeń na płytce drukowanej. Drugi sposób oznacza numerację kanałów zgodną z układem system-on-chip (SOC) firmy Broadcom, który jest użyty w komputerze Raspberry Pi 3B. Ze względu na korzystanie z płytki prototypowej oraz modułu Proto Pi Plus, który korzysta z~oznaczeń odpowiadających kanałom SOC, w projekcie użyto tego właśnie sposobu numeracji.

Inicjalizacja obsługi GPIO wywoływana jest w funkcji:  
\begin{lstlisting} [language=Python]
def init_gpio():
    GPIO.setmode(GPIO.BCM)
\end{lstlisting}
Wykonywana jest ona na początku działania programu \texttt{nadzor.py} w funkcji \texttt{main()}. Obsługa poszczególnych czujników odbywa się w ramach obiektów klasy Grupa. Aktywacja rezystora ściągającego (ang. \textit{pull-down}) do masy jest wywoływana w programie \texttt{nadzor.py} w konstruktorze obiektu klasy Grupa w następujący sposób:
\begin{lstlisting} [language=Python]
GPIO.setup(self.czujnik.gpio, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)
\end{lstlisting}
Pierwszym argumentem tej funkcji jest numer wyprowadzenia GPIO, drugi określa, czy wyprowadzenie ma być skonfigurowane jako wejście (\texttt{GPIO.IN}) czy wyjście (\texttt{GPIO.OUT}). Trzeci argument to znacznik określający, czy ma zostać użyty rezystor ściągający do masy czy podciągający do napięcia zasilania (ang. \textit{pull-up}).

Funkcja realizująca obsługę czujników stykowych zaczyna od sprawdzenia wyprowadzenia o numerze przechowywanym jako atrybut klasy. Zwrócenie stanu wysokiego (oznaczanego jako \texttt{1/GPIO.HIGH/True}) oznacza przypisanie do zmiennej \texttt{stan{\_}czujnika} wartości 1. Jeśli natomiast stan jest niski, to zmiennej przypisywana jest wartość 0. Następnie sprawdzany jest poprzedni stan wyprowadzenia przechowywany jako atrybut obiektu klasy Grupa. Jeśli poprzednio stan był wysoki (styki czujnika był zamknięte), to znaczy, że nastąpiło otwarcie styków czujnika. Zgodnie z wymogami projektowanego systemu następuje wtedy wykonanie zdjęcia -- wywołanie funkcji obsługującej kamery. Na koniec program przechodzi do wysłania powiadomienia e-mail.

\subsection{Wysyłanie powiadomień e-mail}
Jedną z funkcjonalności systemu jest również wysyłanie powiadomienia mailowego po otwarciu czujnika. Jest ono wysyłane przez serwer SMTP firmy Google. Ta decyzja projektowa wynika z faktu, że konfiguracja serwera SMTP działającego na Raspberry Pi wymagałaby posiadania stałego adresu IP dostarczanego przez dostawcę usług internetowych oraz domeny przypisanej do tego adresu. Prostszym rozwiązaniem jest utworzenie konta e-mail w zewnętrznej usłudze (np. Gmail) i korzystanie z jej serwera SMTP. 

Połączenie z serwerem SMTP Google (Gmail) jest nawiązywane przy użyciu modułu \texttt{smtplib} na początku działania programu \texttt{nadzor.py}: 
\begin{lstlisting} [language=Python]
def init_smtp(sender, password):
    smtp_server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
    smtp_server.login(sender, password)
    return smtp_server 
\end{lstlisting}
Wymogiem usługi Gmail jest stosowanie szyfrowanego połączenia SSL, które jest nawiązywane przez funkcję \texttt{SMTP{\_}SSL}. Komunikacja odbywa się na standardowym dla tego połączenia porcie TCP 465. Następnie dokonuje się uwierzytelnienie użytkownika na serwerze poprzez przesłanie adresu email konta, z którego mają być wysyłane wiadomości, oraz hasła do niego. Funkcja zwraca referencję obiektu reprezentującego połączenie z serwerem SMTP.

W przypadku, gdy zostanie otwarty czujnik stykowy, oprócz wykonania zdjęcia, sprawdzany jest stan znacznika powiadomień e-mail. Jeśli jest on równy "on", a adres e-mail odbiorcy powiadomień nie jest pusty, rozpoczyna się procedura wysłania powiadomienia. Przygotowany jest tekst wiadomości zawierający informację o otwarciu czujnika i przypisanej mu nazwie. Na temat wysyłanej wiadomości składa się informacja o otwarciu czujnika oraz dacie i godzinie otwarcia. Następnie zostaje utworzony nowy wątek, w którym jest wywoływana funkcja \texttt{wyslij{\_}email()}. Argumentami tej funkcji są: adres e-mail odbiorcy, temat wiadomości, jej treść oraz nazwa zdjęcia, która będzie dołączona jako załącznik. Do otwarcia wątku użyta jest pomocnicza funkcja \texttt{run{\_}threaded}. Użycie wątku zapewnia, że funkcja wysyłająca powiadomienie jest wykonywana współbieżnie z pozostałymi funkcjami sprawdzającymi stany czujników.

Do przygotowania wiadomości e-mail jest wykorzystany obiekt klasy \texttt{MIMEMultipart}. Reprezentuje on wieloczęściową wiadomość e-mail zgodną ze standardem MIME (ang. \textit{Multipurpose Internet Mail Extensions}) \cite{mime1}\cite{mime2}.  W polach: \texttt{Subject}, \texttt{To} i \texttt{From} zostają wpisane odpowiednio temat, odbiorca i nadawca wiadomości e-mail. Następnie funkcja otwiera plik ze zdjęciem, które zostało wywołane przez otwarcie czujnika i tworzony jest obiekt \texttt{MIMEImage}, który reprezentuje część wiadomości będącej obrazem. Nie jest tu podawany format zdjęcia, ponieważ obiekt sam dokona sprawdzenia typu zdjęcia przy pomocy modułu \texttt{imghdr} \cite{python-mime}. Dzięki temu zmiana formatu zdjęcia np. z JPEG na PNG nie wymaga zmiany tej części kodu. Przed dołączeniem do wiadomości pliku ze zdjęciem konieczne jest również ustawienie nagłówka \texttt{Content-Disposition} z informacją o tym, że jest to załącznik (\textit{attachment}) oraz o~jego nazwie. Dzięki temu obraz zostanie dodany jako załącznik do pobrania w kliencie poczty elektronicznej \cite{content-disposition}. Po dołączeniu załączników następuje wysłanie wiadomości e-mail do serwera SMTP. Operacja ta jest zabezpieczona przy użyciu obiektu \texttt{Lock} z biblioteki \texttt{threading}. Zapewnia to, że kilka wątków nie próbuje jednocześnie korzystać z jednego połączenia z~serwerem SMTP do wysyłania powiadomień e-mail.
\newpage

\section{Baza danych}
\subsection{Założenia wstępne}
Relacyjna baza danych składa się relacji (tabel), które są połączone związkami. W takim modelu organizacji bazy danych łatwo przedstawić rzeczywiste obiekty. Tabela składa się z nagłówka i zawartości. Nagłówek to zbiór atrybutów opisujących zawartość składającą się ze zbioru wierszy. Każda tabela posiada klucz główny, który pozwala jednoznacznie zidentyfikować każdy wiersz. Związki między relacjami są realizowane przez obecność w jednej z tabel uczestniczących w związku klucza obcego, który pozwala jednoznacznie zidentyfikować wiersz z drugiej tabeli.

Dostęp do baz danych jest możliwy przez programowy interfejs silnika bazy danych opartego na transakcjach. Transakcje to zestaw operacji, które powinny być wykonane w całości albo wcale. Dzięki nim możliwe jest zachowanie integralności danych w sytuacji, gdy wiele klientów (programów) zapisuje lub odczytuje dane z bazy danych.

Projekt bazy danych należy rozpocząć od zdefiniowania, jakie obiekty mają być w niej przechowywane. W projektowanym systemie potrzebne są informacje o czujnikach i kamerach podłączonych do systemu Raspberry Pi oraz o wykonanych pomiarach. Wszystkie urządzenia mają nazwę identyfikującą ich położenie lub przeznaczenie, np.: "Kamera w kuchni" lub "Czujnik - drzwi wejściowe". Każdy typ urządzenia różni się jednak specyficznymi dla niego informacjami. Czujnik temperatury dodatkowo potrzebuje informacji o numerze kanału multipleksera, do którego jest podłączony, a czujnik stykowy -- o numerze swojego wyprowadzenia GPIO. Ponadto każdy typ urządzenia wykonuje inny typ pomiaru i odczytu i z tego powodu informacje o urządzeniach będą przechowywane w różnych tabelach -- osobno kamery, czujniki stykowe i czujniki temperatury.

Baza danych powinna przechowywać informację o stanie czujnika zbliżeniowego, wartości zmierzonej temperatury i wilgotności oraz o wykonanym zdjęciu. W bazie danych nie muszą być przechowywane pliki ze zdjęciami, może być to natomiast unikalny identyfikator zdjęcia, który pozwoli zlokalizować je w pamięci urządzenia. Zdjęcia, pomiary temperatury i odczyty czujników stykowych będą wykonywane z różną częstotliwością. Użytkownik potrzebuje natomiast powiązania, jaki w danej chwili jest stan czujnika, odczyt temperatury i wilgotności oraz zdjęcie nadzorowanego miejsca. Konieczna jest więc tabela, która będzie zbierała informacje o ostatnich wykonanych pomiarach dla każdej grupy urządzeń składającej się z: czujnika temperatury i wilgotności, czujnika stykowego oraz kamery. Wpisy do tej tabeli muszą być wykonywane tak często, jak odczyt stanu czujnika stykowego. Wynika to z tego, że jest to najczęściej wykonywana czynność. Pozwala to na jasne dopasowanie zdjęcia oraz zmierzonej temperatury i~wilgotności do odczytu stanu czujnika stykowego.

\subsection{Projekt bazy danych}

Na podstawie powyższych założeń stworzono projekt bazy danych, który jest przedstawiony na rysunku \ref{fig: er}. Przedstawiony schemat bazy danych na poziomie logicznym to zbiór relacji i~związków między nimi, które mogą zostać stworzone w systemie zarządzania. 

\begin{figure}[h]
\includegraphics[width=\linewidth]{er.png}
\caption{Schemat bazy danych na poziomie logicznym}
\label{fig: er}
\end{figure}

Baza zawiera 3 tabele: \texttt{czujniki}, \texttt{kamery} i \texttt{czujniki{\_}temperatury} z informacjami o poszczególnych typach urządzeń dołączonych do systemu. Wszystkie tabele mają podobne pole przechowujące nazwę urządzenia typu VARCHAR(100). W każdej z tych tabel przechowywana jest również częstotliwość wywoływania zdjęcia, pomiaru lub odczytu w polu typu FLOAT. Wartości te są wyrażone w sekundach. Ponadto każda z tabel przechowuje informację pozwalającą zlokalizować urządzenie w systemie. W przypadku czujników stykowych jest to numer wyprowadzenia GPIO, do którego podłączony jest czujnik. Czujniki temperatury i wilgotności są identyfikowane przez numer kanału multipleksera, do którego są dołączone. Kamery można rozróżnić dzięki polu \texttt{sciezka{\_}urzadzenia} zawierającym ścieżkę pliku urządzenia. Jest to plik, który system Linux używa do identyfikowania urządzeń dołączonych np. przez USB. 

Tabele: \texttt{stany}, \texttt{zdjęcia} i \texttt{odczyty} zawierają informacje o realizacjach pomiarów wykonanych przez te urządzenia. Relacja \texttt{stany} odpowiada odczytom stanów czujników stykowych. Każdy wpis w tabeli jest jednym odczytem  stanu jednego czujnika. Odczyt stanu jest przechowywany w polu \texttt{stan} typu SMALLINT, ponieważ jest zaprojektowany do przechowywania tylko wartości 0 albo 1. W tabeli \texttt{odczyty} przechowywane są pomiary temperatury i wilgotności względnej z jednego czujnika temperatury. Są one liczbami zmiennoprzecinkowymi i dlatego są zapisywane w polach typu FLOAT. Jeśli pomiar został wykonany błędnie, zostanie dokonany wpis do tabeli \texttt{odczyty} zawierający wartości NULL w polach \texttt{temperatura} i \texttt{rh}. Wpisy w tabeli \texttt{zdjęcia} zawierają nazwę pliku ze zdjęciem wykonanym przez kamerę. Jeśli jednak zdjęcie nie zostanie wykonane prawidłowo, w polu \texttt{nazwa} zostanie wpisana wartość NULL.

Tabela \texttt{pomiary} przedstawia status systemu, zawierając klucze obce aktualnych w danym momencie zdjęć, odczytów i stanów, pochodzących ze zgrupowanych urządzeń. Jedno zdjęcie lub odczyt temperatury i wilgotności może być przypisane do wielu pomiarów, ale do jednego pomiaru jest przypisany tylko jeden stan czujnika stykowego. Wynika to z tego, że w programie \texttt{nadzor.py} wpisy do tabeli \texttt{pomiary} są wykonywane po odczycie stanu czujnika. Następuje on domyślnie co 0,1 sekundy, tak aby wykrywać oddalenie czujników. Data i godzina jest przechowywana w polu o typie DATETIME. 
 
Poza wspomnianymi wyżej relacjami istnieje również relacja \texttt{ustawienia}, która nie jest w~związku z~żadną inną. Jest to tabela przechowująca różne ustawienia systemu, które nie dotyczą bezpośrednio urządzeń. Posiada ona dwie kolumny: \texttt{klucz} i \texttt{wartosc}. Kolumna \texttt{klucz} jest opisem ustawienia, a \texttt{wartosc} przechowuje informację o nim np. adres e-mail, na który mają być wysyłane powiadomienia. 

Każdy wpis w tabeli \texttt{kamera} przechowuje klucze przypisanych do niej czujników stykowego oraz temperatury i wilgotności. Dzięki temu można powiązać kamerę oraz czujnik stykowy, który ma wywoływać wykonanie zdjęcia. Odpowiada to związkom jeden do jednego między relacjami: \texttt{kamery} i \texttt{czujniki} oraz \texttt{kamery} i \texttt{czujniki{\_}temperatury}.

\subsection{Praktyczna realizacja bazy danych}
Baza danych została zaimplementowana przy użyciu systemu zarządzania MySQL. Do stworzenia tabel został napisany skrypt w języku Python. Wykorzystuje on moduł \texttt{SQLAlchemy}, który umożliwia działanie na relacjach bazy danych jak na obiektach programistycznych. Takie odwzorowanie nazywa się mapowaniem obiektowo-relacyjnym (ang. \textit{Object-Relational Mapping} ORM). Ułatwia ono wprowadzanie kolejnych zmian do struktury bazy danych, relacji i~związków między nimi.

Bazę danych należy stworzyć, wywołując polecenie w panelu zarządzania bazą danych przy użyciu polecenia:
\begin{lstlisting} [language=SQL]
CREATE DATABASE nadzor;
\end{lstlisting}
Plik zawierający program tworzący tabele w bazie danych nosi nazwę \texttt{baza.py}. W pierwszej kolejności należy stworzyć klasę \texttt{Base}, która zapewnia mapowanie do tabel w bazie danych. Proces tworzenia tabel w bazie polega na stworzeniu klasy odpowiadającej każdej tabeli w bazie, która dziedziczy po klasie \texttt{Base}\cite{sqlalchemy-base}.
\begin{lstlisting} [language=Python]
class Pomiary(Base):
    __tablename__ = 'pomiary'
    id_pomiaru = Column(Integer, primary_key=True)
    id_stanu = Column(Integer, ForeignKey('stany.id_stanu', ondelete='CASCADE'), nullable=False)
    id_odczytu = Column(Integer, ForeignKey('odczyty.id_odczytu', ondelete='CASCADE'), nullable=False)
    id_zdjecia = Column(Integer, ForeignKey('zdjecia.id_zdjecia', ondelete='CASCADE'), nullable=False)
    data = Column(DATETIME)
    stany = relationship(Stany)
    odczyt = relationship(Odczyty)
    zdjecia = relationship(Zdjecia)
\end{lstlisting}

Klasa Pomiary posłuży jako przykład tworzenia tabeli w bazie danych. Należy zdefiniować atrybut \texttt{{\_\_}tablename{\_\_}}, który jest unikalną nazwą tabeli. Następnie tworzone są kolumny przez wywołanie konstruktora klasy Column. W konstruktorze należy przekazać argument będący typem danych przechowywanych w kolumnie. Dla kolumny będącej kluczem głównym należy ustawić znacznik \texttt{primary{\_}key} jako \texttt{True}. Do zdefiniowania związku z inną relacją należy podać jako argument obiekt klasy \texttt{ForeignKey} z informacją, która kolumna w danej tabeli służy jako klucz obcy. Następnie należy zdefiniować związek, wywołując funkcję \texttt{relationship()}. Przyjmuje ona jako argument nazwę klasy. Oznacza to, że definicja tej klasy musi być stworzona wcześniej w kodzie programu.

Dla wszystkich użytych czujników i kamer należy również stworzyć odpowiadające im rekordy w bazie danych. Odpowiada za to program \texttt{insert.py}. Proces tworzenia nowego wpisu w~tabeli polega na stworzeniu słownika zawierającego nazwy kolumn i wartości, które mają być im przypisane. Następnie wywoływana jest funkcja \texttt{get{\_}or{\_}create()}, która najpierw sprawdza, czy istnieje rekord w bazie danych o takich wartościach. Jeśli już istnieje, to zwraca go. Jeśli nie istnieje, to tworzy nowy rekord. Dzięki temu do programu można dopisywać kolejne wywołania, tworzące nowe rekordy w bazie danych i uruchamiać program, który nie stworzy duplikatów już istniejących rekordów. Poniżej przedstawiono przykład stworzenia nowego wpisu w tabeli \texttt{kamery} zgodnie z opisaną wyżej procedurą. Argumentami funkcji \texttt{get{\_}or{\_}create()} są:
\begin{itemize}
\item obiekt klasy \texttt{Session}, która zarządza transakcjami z bazą danych \cite{sqlalchemy-session},
\item nazwa klasy odpowiadającej tabeli, dla której ma być stworzony obiekt,
\item słownik argumentów kluczowych poprzedzony operatorem \texttt{**}.
\end{itemize}
\begin{lstlisting} [language=Python]
titanum_1_kwargs = {
    "nazwa_kamery": "Kamera 1 - Titanum",
    "sciezka_urzadzenia": "/dev/video0",
    "id_czujnika": kontaktron_1.id_czujnika,
    "id_czujnika_temp": si7021_zielony.id_czujnika_temp,
    "czestotliwosc_zdjecia": 10.0
}
titanum_1 = get_or_create(session, Kamery, **titanum_1_kwargs)
\end{lstlisting}

W podobny sposób dokonywane są zapisy do tabel: \texttt{stany}, \texttt{zdjęcia} i \texttt{odczyty}. Wykonywane są one w programie \texttt{nadzor.py} odpowiednio w funkcjach: \linebreak\texttt{sprawdz{\_}kontaktron()}, \texttt{pomiar{\_}temperatury{\_}rh} i \texttt{zrob{\_}zdjecie}. Przykładowo, wyniki pomiarów temperatury i wilgotności zostają zapisane do słownika przy kluczach odpowiadających nazwom odpowiednich kolumn w tabeli. Pozostałym polem w słowniku jest identyfikator czujnika stykowego, dla którego został wykonany odczyt. Następnie wynik zostaje zapisany do bazy danych przez funkcję \texttt{create()}. Jej argumenty są takie same jak opisanej wyżej funkcji \texttt{get{\_}or{\_}create()}. Zwrócony obiekt odpowiadający nowemu wpisowi w bazie danych jest zapisywany w odpowiednim polu klasy Grupa.
\begin{lstlisting} [language=Python]
odczyt = {
	"id_czujnika_temp": self.czujnik_temp.id_czujnika_temp,
	"temperatura": temp,
	"rh": rh
}
self.odczyt_instance = create(self.session, Odczyty, **odczyt)
\end{lstlisting}

Odczyt czujników stykowych jest najczęściej wykonywanym pomiarem, więc po stworzeniu nowego wpisu w tabeli \texttt{stany} powinien zostać stworzony wpis do tabeli pomiary. Zostaje do niej wpisany rekord zawierający identyfikator właśnie wykonanego odczytu stanu oraz identyfikatory ostatnich wykonanych zdjęć oraz pomiarów temperatury odczytane z pól obiektu klasy Grupa. Wraz z nimi zostaje zapisana data i godzina wpisu odczytana przy pomocy funkcji \texttt{datetime.now()}, zapisana w formacie: \textit{dzień-miesiąc-rok godzina-minuta-sekunda.mikrosekunda}. Platforma Raspberry Pi nie posiada wbudowanego, sprzętowego zegara czasu rzeczywistego (ang. \textit{Real-Time Clock} RTC), natomiast w momencie uruchomienia systemu operacyjnego po nawiązaniu połączenia z Internetem pobiera przez protokół NTP (ang. \textit{Network Time Protocol}) aktualny czas i synchronizuje w ten sposób zegar systemowy.
\begin{lstlisting}
pomiar = {
	"id_stanu": stan_instance.id_stanu,
	"id_odczytu": self.odczyt_instance.id_odczytu,
	"id_zdjecia": self.zdjecie_instance.id_zdjecia,
	"data": data
}
pomiar_instance = create(self.session, Pomiary, **pomiar)
\end{lstlisting}

\newpage

\section{Serwer HTTP i strona WWW}

\subsection{Serwer HTTP}
Jednym z wymogów wobec projektowanego systemu jest umożliwienie użytkownikowi dostępu do zebranych danych przez stronę WWW. Konieczne jest zatem uruchomienie serwera HTTP, na którym będzie umieszczona strona. Jednym z najpopularniejszych środowisk do prowadzenia serwerów tego typu jest Apache. Jest ono dostępne również w wersji dla systemu Raspbian, który działa na platformie Raspberry Pi w projektowanym systemie. Umieszczona na serwerze strona WWW będzie komunikowała się z serwerem przez żądania HTTP. Szkielet strony w~postaci pliku HTML będzie wypełniony danymi zebranymi przez kamery i czujniki po zrealizowaniu żądań wysyłanych asynchronicznie (przy użyciu techniki AJAX) do serwera. Za obsługę żądań po stronie serwerowej będą odpowiedzialne mikrousługi w postaci skryptów w języku PHP. Skrypty te łączą się z bazą danych, w której są przechowywane dane zebrane z kamer i~czujników. Następnie zwracają one wyniki zapytań do bazy w odpowiedzi na żądanie klienta. Język PHP został wybrany do obsługi żądań po stronie serwerowej, ponieważ jest dobrze zintegrowany z serwerem Apache i jest jedną z najbardziej popularnych technologii dla serwerów HTTP.

Dostęp do prezentowanych danych powinien być zabezpieczony. Autoryzacja użytkownika na stronie została wykonana w formie uwierzytelnienia prostego (ang. \textit{basic authentication}). Wymaga ono jedynie stworzenia na serwerze pliku z hasłem przy użyciu narzędzia \texttt{htpasswd} będącego częścią pakietu Apache. Plik z hasłem jest przechowywany poza folderem, w którym są przechowywane pliki strony internetowej, dzięki czemu jest poza zasięgiem ewentualnego ataku. Hasło przechowywane jest w formie 128-bitowego skrótu (ang. \textit{hash}) stworzonego przy pomocy funkcji skrótu MD5 \cite{apache-password}. Dzięki temu nie jest ono dostępne  w formie prostego tekstu, który mogłyby być od razu odczytany w wypadku zdobycia dostępu do pliku przez niepożądaną osobę. Z hasła przesłanego przez użytkownika również tworzony jest skrót, który jest następnie porównywany ze skrótem hasła przechowywanym w pliku na serwerze. Jeśli oba skróty są równe, oznacza to, że przesłane hasło jest poprawne. Komunikacja między serwerem a klientem odbywa się w formie nieszyfrowanej, przez co klient wysyła swoje hasło i login otwartym tekstem w nagłówku żądania HTTP \cite{http-auth}. Tym samym osoba podsłuchująca komunikację mogłaby poznać dane logowania. Jest to słaby punkt zabezpieczeń systemu w obecnej postaci, którą należałoby w przyszłości wyeliminować, używając szyfrowania SSL w komunikacji przy użyciu protokołu HTTP. Innym usprawnieniem byłoby użycie funkcji skrótu z rodziny SHA-2 lub SHA-3 do generowania skrótów haseł przechowywanych na serwerze. Są one obecnie uważane za niemożliwe do złamania.
 
\subsection{Żądania HTTP i ich obsługa -- technika AJAX}
Po pozytywnym uwierzytelnieniu użytkownika w systemie udostępniony jest plik \texttt{index.html}. Zawiera on szkielet strony oraz dołączone skrypty JavaScript w tym skrypt \texttt{main.js}, który zawiera funkcje realizujące żądania HTTP. Służą one do pobierania danych z systemu oraz wprowadzania ustawień dokonanych przez użytkownika. Wykorzystania została do tego technika AJAX (ang. \textit{Asynchronous JavaScript and XML}). Jest to technika tworzenia aplikacji internetowych, w której żądania są wykonywane asynchronicznie. Technika ta jest oparta o architekturę serwer-klient, w której rolę klienta pełni przeglądarka. Po wysłaniu żądania przeglądarka kontynuuje działanie, a w tym czasie serwer realizuje żądanie. Po zakończeniu obsługi żądania serwer wysyła odpowiedź do przeglądarki, która odbiera dane i przetwarza je. Dzięki temu treść strony może być odświeżana bez konieczności jej przeładowywania \cite{ajax}. Jest to przydatne do odświeżania danych w tle tak, by użytkownik obserwował aktualny stan systemu.

Do przygotowania żądań HTTP wykorzystywana jest funkcja \texttt{\$.ajax()} z biblioteki jQuery \cite{jquery_ajax}. Przygotowuje ona obiekt \texttt{XMLHTTPRequest}, reprezentujący żądanie HTTP. Funkcja ta pozwala również określić adres URL, do którego ma być skierowane żądanie, typ żądania (GET, POST, DELETE itp.), dołączone dane oraz pozostałe pola odpowiadające nagłówkom protokołu HTTP. Żądania te będą kierowane do dedykowanych programów w języku PHP działających na~serwerze WWW. Wykonują one zapytania do bazy danych i zwracają ich wyniki lub dokonują wpisów do bazy danych. Działanie poszczególnych skryptów zostanie omówione w dalszych podrozdziałach.

\subsubsection{Strona główna i archiwum}
Podstawowym żądaniem wywoływanym przez funkcję \texttt{main.js} jest żądanie pobrania aktualnego stanu systemu. Jest ono wywoływane w funkcji \texttt{main()} przez funkcję \texttt{getData()}:
\begin{lstlisting} [language=JavaScript]
function getData() {
    return $.ajax({
        url: "get_data.php?q=",
        type: "GET",
        contentType: "text/plain"
    })
}
\end{lstlisting}
Funkcja przygotowuje żądanie typu GET do mikrousługi \texttt{get{\_}data.php} z pustym parametrem \texttt{q}. Informuje on o tym, że mają być przesłane tylko dane o aktualnym stanie systemu. Funkcja zwraca obiekt typu \texttt{Promise} (ang. \textit{obietnica}), który reprezentuje ostateczne zakończenie lub~niepowodzenie operacji asynchronicznej \cite{promise}. 

Po otrzymaniu żądania program \texttt{get{\_}data.php} odczytuje ze zmiennej \texttt{{\$\_}GET} wartość parametru \texttt{q}. Posłuży on do określenia, jakie zapytania maja być wysłane do bazy danych. Następnie nawiązywane jest połączenie z bazą danych przy pomocy biblioteki PDO:
\begin{lstlisting} [language=PHP]
$conn = new PDO("mysql:host=$servername;dbname=$db", $username, $password);
\end{lstlisting}
Zmienna \texttt{\$conn} reprezentująca połączenie z bazą danych jest użyta do wykonania zapytania o wszystkie wpisy z tabeli \texttt{kamery}. Jeśli parametr \texttt{q} jest pusty, to dla każdej kamery z tabeli jest wykonywane zapytanie do tabeli \texttt{pomiary} o ostatnio wykonany wpis:
\begin{lstlisting} [language=PHP]
$stmt = $conn->query("
SELECT *
FROM pomiary NATURAL JOIN zdjecia NATURAL JOIN stany NATURAL JOIN odczyty
WHERE zdjecia.id_kamery = $id_kamery  
ORDER BY pomiary.id_pomiaru DESC LIMIT 1
");
\end{lstlisting}
Wynik tego zapytania jest zapisywany w tablicy pod indeksem równym unikalnemu identyfikatorowi kamery. Po dokonaniu zapytań dla wszystkich kamer istniejących w systemie, program zwraca odpowiedź w formie JSON (ang. \textit{JavaScript Object Notation}). Jest to jeden z powszechnie stosowanych formatów tekstowej wymiany danych. W nagłówku odpowiedzi należy przekazać informację o typie MIME przekazywanych danych\cite{mime2} -- \texttt{Content-Type: \linebreak application/json}. Następnie dane są kodowane do postaci JSON przy użyciu funkcji \linebreak\texttt{json{\_}encode} i zwrócone przez funkcję \texttt{echo}.

Zwrócone dane można obsłużyć po stronie klienta (przeglądarki) na kilka sposobów. Jedną z najnowszych metod dostępnych w wersji języka JavaScript ECMAScript 2017 jest składnia \texttt{async/await}. Jest ona obsługiwana przez większość współczesnych przeglądarek w najnowszej wersji \cite{async}. Pozwala ona na zapis asynchronicznego kodu w sposób przypominający tradycyjny, sekwencyjny. Zaletą takiego rozwiązania jest poprawienie czytelności kodu źródłowego programu. 

Definicja funkcji działającej w sposób asynchroniczny musi być poprzedzona słowem kluczowym \texttt{async}. W ciele funkcji można wówczas wywoływać funkcje zwracające obiekty Promise ze słowem kluczowym \texttt{await}. Powoduje to wstrzymanie działania funkcji do momentu rozwiązania obietnicy:
\begin{lstlisting} [language=JavaScript]
async function main() {
    try {
        const result = await getData();
        displayHomeContent(result);
        (...)
    } catch (e) {
        console.log(e.responseText);
        (...)
    }
	(...)
}
\end{lstlisting}
Funkcja \texttt{getData()} jest wywoływana w bloku \texttt{try/catch} pozwalającym na obsługę wyjątków w przypadku niepowodzenia asynchronicznego żądania HTTP. W przypadku pozytywnego zakończenia żądania dane zwrócone w odpowiedzi są zapisywane do zmiennej i mogą być użyte przez funkcję \texttt{displayHomeContent()} wyświetlającą dane na stronie głównej.

Procedura pobierania danych o archiwalnych stanach systemu jest zrealizowana w podobny sposób. Przesłanie żądania do serwera wykonuje funkcja \texttt{getAllData()}. Wywołuje ona żądanie typu GET do mikrousługi \texttt{get{\_}data.php} z atrybutem \texttt{q} równym \texttt{archiwum}. Po stronie serwerowej żądanie obsługiwane jest podobnie do żądania z pustym atrybutem \texttt{q}. Różnica polega na tym, że dla każdej kamery w systemie zwracana jest cała historia jej zdjęć przy użyciu poniższego zapytania do bazy danych:
\begin{lstlisting} [language=PHP]
$stmt = $conn->query("
SELECT *
FROM zdjecia NATURAL JOIN pomiary NATURAL JOIN stany NATURAL JOIN odczyty
WHERE zdjecia.id_kamery = $id_kamery
");
\end{lstlisting}
Następnie dane są zapisywane w formie JSON i zwracane do klienta przez funkcję \texttt{echo}. Po stronie przeglądarki obiekt \texttt{Promise} zwracany przez funkcję \texttt{getAllData()} również jest obsługiwany przy pomocy składni \texttt{await/async}. Po pozytywnym zakończeniu pobierania danych tworzony jest widok archiwum.

\subsubsection{Ustawienia}
Przez stronę WWW użytkownik ma również dostęp do panelu administracyjnego pozwalającego na zmianę ustawień. Aktualnie dostępne ustawienia to:
\begin{itemize}
\item włączenie powiadomień e-mail i podanie adresu e-mail odbiorcy powiadomień,
\item zmiana nazwy urządzeń przyłączonych do systemu,
\item zmiana częstotliwości wykonywania zdjęć i pomiarów.
\end{itemize}

Po dokonaniu zmian w formularzu i ich zapisaniu, skrypt \texttt{main.js} zapisuje dane ze wszystkich elementów HTML typu \texttt{form}. Wykorzystywana jest przy tym funkcja \linebreak \texttt{serializeArray()} z biblioteki jQuery. Zapisuje ona dane z formularza do tablicy obiektów o postaci: \texttt{\{name: <Nazwa ustawienia>, value: <Wartość ustawienia>\}}. W przypadku formularzy z danymi dotyczącymi ustawień nazw urządzeń i częstotliwości pomiarów obiekty te zostaną przekształcone do postaci: \texttt{\{<Nazwa ustawienia>:\linebreak <Wartość ustawienia>\}}. Jest ona łatwiejsza do parsowania po stronie serwera, ponieważ bezpośrednio łączy nazwę kolumny z wartością, która ma być dla niej ustawiona. Wykorzystana do tego zostanie wbudowana funkcja obiektu \texttt{Array} -- \texttt{reduce()}:
\begin{lstlisting}[language=JavaScript]
const data = $(element).serializeArray().reduce((a, x) => {
	a[x.name] = x.value;
	return a;
}, {});
\end{lstlisting}
Pierwszym argumentem funkcji \texttt{reduce()} jest anonimowa funkcja wywołana przy pomocy wyrażenia funkcji strzałkowej (\texttt{=>}). Jest ona wywoływana dla każdego elementu tablicy i wykorzystuje dwa argumenty: tablicę, która ma być spłaszczona (\texttt{a}) oraz aktualny element tablicy (\texttt{x}). Wartość ustawienia jest zapisywana przy kluczu ją opisującym, a wynik działania funkcji zapisywany jest w nowym obiekcie podanym jako drugi argument funkcji -- \texttt{\{\}}. W ten sposób dane są zapisane w formie JSON. Przed dołączeniem do ciała funkcji muszą one być zmienione z~obiektu do postaci ciągu znaków (\texttt{string}).

Każde z wymienionych wyżej ustawień posiada osobną funkcję przygotowującą żądanie typu POST do serwera. Jest to typ żądania HTTP używany do przesyłania danych z formularzy \cite{http}. Wynika to z tego, że każda z tych danych jest inaczej przetwarzane po stronie serwera. Dla ustawień e-mail jest to funkcja \texttt{updateSettings()}. Wysyła ona żądanie typu POST do mikrousługi \texttt{update{\_}settings.php}. Program ten zaczyna od zdekodowania przesłanych danych w formie JSON do tablicy:
\begin{lstlisting}[language=PHP]
$input = json_decode(file_get_contents('php://input'))
\end{lstlisting}
Następnie dla każdego ustawienia (pary: klucz/wartość) wykonywane jest zapytanie typu UPDATE do bazy danych o następującej treści:
\begin{lstlisting}[language=SQL]
UPDATE ustawienia 
SET wartosc=:wartosc
WHERE klucz=:klucz
\end{lstlisting}
gdzie \texttt{:wartosc} oraz \texttt{:klucz} zostaną uzupełnione odpowiednimi danymi w momencie wykonywania zapytania przez funkcję \texttt{execute()}. Zastosowanie tej techniki -- parametryzowanych zapytań -- zabezpiecza system przed atakami typu \textit{SQL Injection}. Polegają one na umieszczeniu np. w~treści formularza obcego zapytania języka SQL, które umieszczone bezpośrednio w treści zapytania mogłoby zostać wykonane i narazić bazę danych np. na usunięcie którejś z~tabel.\cite{sql-injection}

Informacje o zmianie nazw urządzeń są przesyłane w postaci żądania HTTP typu POST przez funkcję \texttt{updateNames()} do mikrousługi \texttt{update{\_}names.php}. Dla każdej kamery i~przypisanych do niej czujników jest wysyłane osobne żądanie zawierające wprowadzone nazwy oraz identyfikator kamery. Program \texttt{update{\_}names.php} po zdekodowaniu przesłanych danych wykonuje zapytanie do bazy danych o identyfikatory czujników, które są przypisane do kamery o przesłanym identyfikatorze. Następnie dla każdego urządzenia następuje aktualizacja nazw, jeśli przesłany ciąg znaków nie jest pusty. W tym przypadku również użyto parametryzowanych zapytań.

Zmiana preferencji wykonywania pomiarów i zdjęć jest przekazywana do serwera przy użyciu funkcji \texttt{updatePrefs()}. Przekazuje ona zebrane z formularza dane do mikrousługi \texttt{update{\_}prefs.php}, załączając je do żądania typu POST. Dane te również są wysyłane osobno dla każdej grupy urządzeń z identyfikowanych kluczem głównym obiektu typu kamera. W tym wypadku dane są zmieniane w zbiorczym zapytaniu do bazy danych:
\begin{lstlisting}[language=SQL]
UPDATE 
kamery NATURAL JOIN czujniki NATURAL JOIN czujniki_temperatury 
SET 
kamery.czestotliwosc_zdjecia = :czestotliwosc_zdjecia, 
czujniki.czestotliwosc_odczytu_stanu = :czestotliwosc_odczytu_stanu,
czujniki_temperatury.czestotliwosc_pomiaru_temp = :czestotliwosc_pomiaru_temp
WHERE 
id_kamery = :id_kamery
\end{lstlisting}

Każde z wykonywanych żądań zwraca obiekt \texttt{Promise}, który jest umieszczany na liście. Po umieszczeniu wszystkich obiektów na liście wywoływana jest metoda \texttt{Promise.all()}. Czeka ona na rozwiązanie wszystkich obiektów \texttt{Promise}. Jeśli wszystkie zakończą się powodzeniem, wykonywana jest funkcja przekazana w pierwszym argumencie. Wyświetla ona powiadomienie o sukcesie aktualizacji ustawień. Jeśli jednak przynajmniej jedno żądanie zakończy się niepowodzeniem, wykonywana jest funkcja wyświetlająca powiadomienie o błędzie.

\subsubsection{Eksport zdarzeń}
Wymagania wobec projektowanego systemu mówią również o możliwości eksportu listy zdarzeń (stanów systemu) do pliku w formacie \texttt{csv}. Wysłanie żądania pobrania pliku jest realizowanie inaczej niż w opisanej poprzednio technice AJAX. W tym celu zostaje otwarte nowe okno przeglądarki, którego adres URL jest ustawiony jako: \texttt{export{\_}events.php?\linebreak start=<Data początku>{\&}end=<Data końca>}. Użytkownik może wybrać w interfejsie przedział dat, dla których mają być wyeksportowane zdarzenia. Są one umieszczane jako wartości parametrów \texttt{start} i \texttt{end}. Otwarte okno jest puste i zamyka się zaraz po otwarciu okna dialogowego do zapisu pliku, o który prosi użytkownik:
\begin{lstlisting}[language=JavaScript]
let url = 'export_events.php?start=';
if (startDate != null) url = url + startDateString;
url = url + '&end=';
if (endDate != null) url = url + endDateString;
window.open(url, '_blank');
\end{lstlisting}

Otwarcie nowego okna w przeglądarce z adresem URL programu \texttt{export{\_}events.php} powoduje wywołanie jego działania po stronie serwerowej. Program pobiera wartości parametrów URL \texttt{start} i \texttt{end}, a następnie wykonuje zapytanie do bazy danych o pierwszy i ostatni rekord z tabeli \texttt{pomiary}. Jeśli użytkownik nie wybrał daty początku lub końca zakresu, dla którego mają być eksportowane zdarzenia, zostaną one domyślnie ustawione odpowiednio jako data pierwszego lub ostatniego wpisu w bazie danych. Takie podejście pozwala na eksport wszystkich zdarzeń poprzez pozostawienie pustych wartości parametrów \texttt{start} i \texttt{end}.

Następnie wykonywane jest zapytanie do bazy danych o wszystkie wpisy do tabeli \texttt{pomiary} wraz z odpowiadającym im zdjęciom, odczytom stanów oraz pomiarom temperatur i wilgotności wraz z informacjami o urządzeniach, które te pomiary wykonały:
\begin{lstlisting}[language=SQL]
SELECT *
FROM pomiary 
NATURAL JOIN zdjecia NATURAL JOIN kamery
NATURAL JOIN stany NATURAL JOIN czujniki
NATURAL JOIN odczyty NATURAL JOIN czujniki_temperatury
WHERE data BETWEEN :first_date AND :last_date
\end{lstlisting}
Dane zwrócone przez zapytanie są zapisywane do pliku w formacie \texttt{csv} o nazwie informującej o wybranym przedziale dat. W pliku tym zapisywane są również nagłówki kolumn, dzięki czemu użytkownik otrzyma informację o tym, co przedstawiają dane. Po zakończeniu zapisu do pliku, jego zawartość jest zwrócona użytkownikowi przy pomocy funkcji \texttt{readfile}. Plik jest przechowywany na serwerze w folderze \texttt{log}. Dzięki temu kolejne zapytania o zdarzenie z tego samego zakresu dat nie wymagają już przeprowadzenia zapytania do bazy danych. Przed przeprowadzeniem zapytania program bowiem sprawdza, czy istnieje już plik o nazwie odpowiadającej żądanemu przedziałowi dat. Jeśli tak, plik zostaje odczytany i zwrócony do klienta.

Aby zwrócone dane były potraktowane jako plik do zapisania i jako załącznik, konieczne jest właściwe ustawienie nagłówków odpowiedzi:
\begin{lstlisting}[language=PHP]
header("Content-Description: File Transfer");
header("Content-Type: application/octet-stream");
header('Content-Disposition: attachment; filename="'.basename($file).'"');
\end{lstlisting}
Odpowiadają one za przekazanie informacji klientowi, że następuje transfer pliku (\texttt{File Transfer}) typu binarnego (\texttt{application/octet-stream}), który ma zostać zapisany po otwarciu okna dialogowego do zapisu plików (\texttt{Content-Disposition: attachment}) \cite{content-disposition},\cite{mime2}.

\subsection{Interfejs użytkownika}
Interfejs użytkownika stanowi strona WWW typu \textit{single-page application} (SPA), której szkielet jest opisany w pliku \texttt{index.html}. Idea podejścia typu SPA polega na stworzeniu strony WWW, która nie wymaga przeładowywania, żeby prezentować różną zawartość, a wszystkie dane mogą być udostępniane przez jeden plik HTML. Odświeżanie zawartości strony następuje w tle dzięki komunikacji z serwerem WWW. W projektowanym systemie komunikacja ta została wykonana zgodnie z techniką AJAX opisaną w poprzednich podrozdziałach. Do wykonania interfejsu użytkownika posłużono się biblioteką \textit{UIKit}, która dostarcza gotowe rozwiązania takich elementów, jak np. okna modalne czy elementy nawigacyjne.

Na stronie głównej przedstawionej na rysunku \ref{fig: homepage} domyślnie wyświetlane są ostatnie zdjęcia ze wszystkich kamer w systemie. Na karcie kamery znajdują się opisy: nazwa kamery, ostatnie zdjęcie nią wykonane oraz dane z czujnika temperatury i wilgotności oraz czujnika stykowego przypisanego do kamery. Dane te są odświeżane domyślnie co 8 sekund (częściej niż wykonywane zdjęcia), tak aby stale prezentować użytkownikowi aktualny stan systemu. 
\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{ekran_glowny.png}
\caption{Strona główna interfejsu użytkownika}
\label{fig: homepage}
\end{center}
\end{figure}
Pasek nawigacyjny u góry ekranu pozwala przejść do \textit{Archiwum} prezentującego wcześniejsze zdjęcia podzielone według kamer, które je wykonały. Zdjęcia są przedstawiane w postaci miniatur umieszczonych na siatce. Po kliknięciu na nie zdjęcie powiększa się, zajmując cały ekran. Wówczas zdjęcia można również przeglądać w trybie galerii zdjęć. Galeria zdjęć została zaimplementowana przy użyciu obiektu \textit{Lightbox} z biblioteki \textit{UIkit} \cite{uikit}.

Wybór odnośnika \textit{Zapisz} otwiera okno modalne z dwoma polami do wyboru dat. Na rysunku \ref{fig: eksport} widać stan okna w przypadku wybrania początkowej daty. Wówczas w drugim kalendarzu do wyboru dat dostępny jest wyłącznie zakres dat następujący po wybranej dacie początku. Implementację kalendarza do wyboru dat dostarcza biblioteka \textit{Pikaday}\cite{pikaday}. W chwili tworzenia obiektu można podać nazwę funkcji, która ma być wykonywana w momencie wybrania daty (zdarzenie \texttt{OnSelect}). W przypadku kalendarza do wyboru początkowej daty jest to funkcja \texttt{updateStartDate}, a dla kalendarza do wyboru końcowej daty -- \texttt{updateEndDate}:
\begin{lstlisting}[language=JavaScript]
function updateStartDate(startDate, startPicker, endPicker) {
    startPicker.setStartRange(startDate);
    endPicker.setStartRange(startDate);
    endPicker.setMinDate(startDate);
}
function updateEndDate(endDate, startPicker, endPicker) {
    startPicker.setEndRange(endDate);
    startPicker.setMaxDate(endDate);
    endPicker.setEndRange(endDate);
}
\end{lstlisting}
Pierwsza z nich odpowiada za ustawienie wybranej daty początkowej jako najmniejszej możliwej daty w kalendarzu do wyboru daty końcowej. Druga wykonuje analogiczną operację z wybraną datą końcową i kalendarzem do wyboru daty początkowej. Dzięki temu interfejs nie pozwala na wprowadzenie błędnych zakresów dat np. takich, w których data początku jest późniejsza niż data końca.
\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{eksport_zdarzen.png}
\caption{Okno modalne do eksportu listy zdarzeń}
\label{fig: eksport}
\end{center}
\end{figure}

Otworzenie okna modalnego z panelem administracyjnym jest możliwe po kliknięciu w odnośnik \textit{Ustawienia}. Na rysunku \ref{fig: ustawienia} widać okno ustawień składające się z kilku formularzy. Sekcja \textit{Ogólne} pozwala na włączenie powiadomień e-mail. Po zaznaczeniu pola wyboru (ang. \textit{checkbox}) tego ustawienia pojawia się również pole tekstowe, w którym można wpisać adres e-mail odbiorcy powiadomień. Kolejna sekcja \textit{Zmień nazwę} składa się z pól tekstowych opisanych dotychczasowymi nazwami urządzeń. Nazwa nie jest zmieniana, jeśli pole pozostawiono puste. Ostatnia sekcja \textit{Preferencje} umożliwia zmianę częstotliwości wykonywania zdjęć i pomiarów. Pola tekstowe opisane nazwa urządzeń są domyślnie wypełnione dotychczasowymi wartościami. Wszystkie zmiany są wprowadzane dopiero po zatwierdzeniu ich przyciskiem \textit{Zapisz}. Zamknięcie okna przyciskiem \textit{Anuluj} powoduje usunięcie wpisanych wartości do formularza i przywrócenie go do pierwotnego stanu.
\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{ustawienia_pomniejszone.png}
\caption{Okno modalne ustawień}
\label{fig: ustawienia}
\end{center}
\end{figure}

\newpage
\section{Testy systemu}
Przeprowadzone testy mają na celu sprawdzenie w kilku scenariuszach, czy system spełnia początkowo postawione wymagania. Uruchomiony zostanie cały system, a jego poprawne działanie będzie weryfikowane na każdym z etapów, tj. od wykonania pomiaru lub zdjęcia i dokonania wpisu do bazy danych, poprzez właściwe przekazanie danych przez serwer HTTP do przeglądarki internetowej i ostatecznie, prawidłowe wyświetlenie danych w interfejsie użytkownika na~stronie WWW.

Środowisko testowe tworzą:
\begin{itemize}
\item komputer Raspberry Pi 3B z zainstalowanym systemem operacyjnym Linux w dystrybucji Raspbian w wersji 8 (jessie), 
\item interpreter języka Python w wersji 3.4,
\item system zarządzania bazą danych MySQL w wersji 5.5.60-0+deb8u1,
\item serwer HTTP Apache w wersji 2.4,
\item język PHP w wersji 5.6.33-0+deb8u1,
\item przeglądarka internetowa Google Chrome w wersji 66, uruchomiona na komputerze PC -- kliencie.
\end{itemize}

\subsection{Test nadzoru}
Pierwszym scenariuszem testowym jest podstawowa próba sprawdzająca działanie systemu przy zbliżonych czujnikach stykowych, które nie będą wyzwalały wykonywania dodatkowych zdjęć. W tym teście sprawdzone będzie, czy zdjęcia oraz pomiary temperatury i wilgotności są prawidłowo wykonywane, zapisywane w bazie danych, a następnie przekazywane do strony WWW. Program wykonujący pomiary należy wywołać komendą w terminalu:\linebreak\texttt{sudo python3 nadzor.py}.

Program powinien działać przez 10 sekund, tak aby wykonały się wszystkie zaplanowane zadania -- zarówno zdjęcia jak i pomiary temperatury i wilgotności. Po tym czasie skierowano do bazy danych zapytanie o wpisy z tabeli \texttt{zdjecia}. Jego wynikiem były nazwy plików dla obu kamer ze zdjęciami składające się z daty i godziny wykonania zdjęć, co oznacza prawidłowe ich wykonanie. Również zapytanie do bazy o wpisy z tabeli \texttt{odczyty} zwróciło wyniki zawierające niepuste wartości w kolumnach \texttt{temp} oraz \texttt{rh}, co oznacza prawidłowe wykonanie pomiarów temperatury i wilgotności względnej. Należy również sprawdzić, czy odczyty stanów czujników stykowych są prawidłowe -- oczekiwana wartość to 1, oznaczająca zbliżone czujniki. Zapytanie dotyczy więc ostatnich dwóch wpisów do tablicy \texttt{stany}. Wszystkie zapytania wraz z~ich wynikami przedstawiono na rysunku \ref{fig: test1}. Wszystkie wpisy okazały się poprawne.
\begin{figure}
\begin{center}
\includegraphics[width=0.8\linewidth]{test1.png}
\includegraphics[width=0.8\linewidth]{test2.png}
\includegraphics[width=0.8\linewidth]{test3.png}
\caption{Wyniki zapytań do bazy danych o ostatnie wykonane zdjęcia (a), odczyty temperatury i wilgotności (b) oraz stany czujników stykowych (c)}
\label{fig: test1}
\end{center}
\end{figure}

Następnie sprawdzono, czy dane są poprawnie przekazywane z serwera HTTP do przeglądarki internetowej. Po otwarciu strony WWW i uwierzytelnieniu w systemie można otworzyć zakładkę deweloperską  
(w Google Chrome: \texttt{Ctrl+Shift+I}). W karcie \textit{Network} znajduje się podgląd wszystkich zapytań kierowanych przez stronę do serwera HTTP. Należy wybrać pierwsze z żądań oznaczonych \texttt{get{\_}data.php?q=} i otworzyć zakładkę \textit{Response}. Znajduje się w~niej treść odpowiedzi przekazanej z serwera WWW do przeglądarki.\linebreak Porównanie wybranych fragmentów odpowiedzi w formacie JSON z wynikami zapytań do bazy danych potwierdza, że przekazane dane są prawidłowe:

\begin{minipage}{.5\textwidth}
\begin{lstlisting}
   "1": {
      "id_odczytu": "101",
      "id_stanu": "2140",
      "id_zdjecia": "116",
      "id_pomiaru": "2130",
      "data": "2018-06-03 12:45:39",
      "id_kamery": "1",
      "nazwa": "2018-06-03_12:45:37.jpg",
      "id_czujnika": "1",
      "stan": "1",
      "id_czujnika_temp": "1",
      "temperatura": "27.55",
      "rh": "51.7126"
   },
\end{lstlisting}
\end{minipage}\hfill
\begin{minipage}{.5\textwidth}
\begin{lstlisting}
   "2": {
      "id_odczytu": "102",
      "id_stanu": "2139",
      "id_zdjecia": "115",
      "id_pomiaru": "2129",
      "data": "2018-06-03 12:45:39",
      "id_kamery": "2",
      "nazwa": "2018-06-03_12:45:27.jpg",
      "id_czujnika": "2",
      "stan": "1",
      "id_czujnika_temp": "2",
      "temperatura": "27.6251",
      "rh": "52.1169"
   }
\end{lstlisting}
\end{minipage}

Kolejnym etapem weryfikacji poprawności działania systemu było sprawdzenie, czy na podstawie danych przekazanych z~serwera HTTP do przeglądarki wyświetlane są w~interfejsie użytkownika prawidłowe informacje o~stanie systemu. Na rysunku \ref{fig: home_test} przedstawione są karty z~aktualnym stanem systemu. Na obu zdjęciach można zaobserwować, że czujniki są zbliżone. Stan czujników jest opisany przy etykietach z~ich nazwą i zgodny z oczekiwaniami ("Zamknięty"), a wartości pomiarów temperatury i wilgotności zostały prawidłowo wyświetlone.

\begin{figure}
\begin{center}
\includegraphics[width=\linewidth]{home_test.png}
\caption{Poprawne wyświetlanie danych w interfejsie użytkownika}
\label{fig: home_test}
\end{center}
\end{figure}

\subsection{Test wyzwalania wykonywania zdjęcia}
Kluczową funkcjonalnością systemu jest wykonywanie zdjęcia wyzwolone działaniem czujnika stykowego przypisanego do kamery. W teście zostanie sprawdzone, czy oddalenie magnesu od~kontaktronu jest wykrywane przez program obsługi kamer i czujników oraz czy wykonywane jest wówczas zdjęcie. Działanie bazy danych oraz serwera WWW w tym przypadku jest identyczne jak w poprzednim teście, więc poprawność działania zostanie zweryfikowana wyłącznie przez interfejs użytkownika. Test należy rozpocząć, wywołując w konsoli program \texttt{nadzor.py}. W~czasie działania programu oddalono magnes od kontaktronu na odległość ok. 20 cm.

Na rysunku \ref{fig: test_otwarty} przedstawiono prezentowany stan interfejsu w przypadku zadziałania czujników stykowych i wyzwolenia zdjęcia. Stan czujników jest prawidłowy opisany jako "Otwarty", a zdjęcia przedstawiają kontaktrony z oddalonymi czujnikami.
\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{test_otwarty.png}
\caption{Informacja w interfejsie o otwartych czujnikach}
\label{fig: test_otwarty}
\end{center}
\end{figure}

System posiada również funkcjonalność wysyłania powiadomień e-mail po zadziałaniu czujnika stykowego. W kolejnym teście została ona sprawdzona przez oddalenie magnesu czujnika stykowego przypisanego do kamery \textit{Creative}. Efektem było wysłanie wiadomości e-mail z treścią informującą o zadziałaniu czujnika. W załączniku wiadomości dołączone było zdjęcie wykonane przez kamerę powiązaną z czujnikiem, którego działanie było testowane. Na rysunku \ref{fig: test_email} przedstawiono treść wiadomości e-mail w kliencie poczty elektronicznej odbiorcy.
\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{test_email.png}
\caption{Wiadomość e-mail z powiadomieniem o zadziałaniu czujnika stykowego}
\label{fig: test_email}
\end{center}
\end{figure}

\subsection{Test obsługi wyjątków}
System powinien prawidłowo informować użytkownika o awariach lub błędach w pomiarach. Przykładem takiej sytuacji jest przypadkowe przerwanie połączenia między komputerem Raspberry Pi a dołączonym czujnikiem czy kamerą. W przypadku czujnika stykowego przerwanie połączenia spowoduje stały stan niski na wyprowadzeniu GPIO, do którego jest on dołączony. Wynika to z tego, że wyprowadzenie GPIO jest dołączone do rezystora ściągającego do masy. Taki rodzaj awarii nie może być w łatwy sposób wykryty. Jednak przerwanie połączenia między czujnikiem temperatury i wilgotności czy kamerą USB a platformą Raspberry Pi może być wykryte i powinno być prawidłowo zasygnalizowane. W przeprowadzonym teście odłączony zostanie przewód USB jednej z kamer oraz przewód dołączony do wyprowadzenia SDA jednego z czujników warunków środowiskowych. Do przeprowadzenia testu należy uruchomić program \texttt{nadzor.py}. Na rysunku \ref{fig: test_bledy} widać wygląd interfejsu użytkownika w czasie testu. Brak wykonanego zdjęcia oznaczony jest ikoną obrazu, który nie został załadowany, ponieważ nazwa pliku ze zdjęciem w bazie danych ma wartość \texttt{NULL}. Niewykonane pomiary temperatury i~wilgotności przez czujnik warunków środowiskowych są przedstawione jako myślniki w miejscu wyników pomiarów.

\begin{figure}[H]
\begin{center}
\includegraphics[width=\linewidth]{test_bledy.png}
\caption{Informacja w interfejsie użytkownika o braku wykonanego zdjęcia oraz błędzie w wykonanym pomiarze}
\label{fig: test_bledy}
\end{center}
\end{figure}

\subsection{Test stabilności pracy}
W tym teście sprawdzono poprawność działania systemu w czasie kilkudniowej i nieprzerwanej pracy. Częstotliwość wyzwalania zdjęć została ustawiona na 10 minut, a częstotliwość pomiaru wilgotności i temperatury -- na 15 minut. Program \texttt{nadzor.py} został uruchomiony na~czas testu od 5.06.2018 00:00 do 7.06.2018 9:05.

Po zakończeniu testu podjęto próbę wejścia na stronę WWW z interfejsem użytkownika. Żądanie pobrania ostatnich zdjęć było przetwarzane dość długo (ponad minutę), co~było zasygnalizowane animacją ładowania. Przyczyną długiego czasu oczekiwania była konstrukcja wykonywanego przez program \texttt{get{\_}data.php} zapytania do bazy danych o ostatnie wykonane zdjęcie:
\begin{lstlisting}[language=SQL]
SELECT *
FROM pomiary NATURAL JOIN zdjecia NATURAL JOIN stany NATURAL JOIN odczyty
WHERE zdjecia.id_kamery = $id_kamery  
ORDER BY pomiary.id_pomiaru DESC LIMIT 1
\end{lstlisting}
Jego działanie jest prawidłowe, jednak przy dużych zbiorach danych łączenie tabel \texttt{pomiary}, \texttt{zdjecia}, \texttt{stany} i \texttt{odczyty} odbywa się dla każdego wpisu, co jest niezwykle kosztowną operacją ze względu na zajętość pamięci. Z tego powodu konieczna okazała się zmiana zapytania na~takie, które będzie dokonywało łączeń jedynie dla szukanego, ostatniego wpisu w~tabeli \texttt{pomiary}:
\begin{lstlisting}[language=SQL]
SELECT * FROM pomiary NATURAL JOIN zdjecia NATURAL JOIN odczyty NATURAL JOIN stany
WHERE id_pomiaru = (
	SELECT id_pomiaru 
	FROM pomiary WHERE id_zdjecia = (
		SELECT id_zdjecia 
		FROM zdjecia 
		WHERE id_kamery = $id_kamery 
		ORDER BY id_zdjecia DESC LIMIT 1
	)
	ORDER BY pomiary.id_pomiaru DESC LIMIT 1
\end{lstlisting}
Udało się to osiągnąć przy użyciu trzech zagnieżdżonych zapytań typu \texttt{SELECT}. Jako pierwsze wykonywane jest zapytanie o identyfikator \texttt{id{\_}zdjecia} ostatniego zdjęcia, które zostało wykonane przy pomocy wybranej kamery. Jego wynik jest użyty w drugim zapytaniu: o identyfikator ostatniego wpisu w~tabeli \texttt{pomiary}, do którego przypisane jest to zdjęcie. Pojedynczy identyfikator pomiaru zostanie użyty do wykonania trzeciego zapytania do tabeli \texttt{pomiary}, które zwraca ostatni wpis ze zdjęciem wykonanym wybraną kamerą wraz z informacją o stanie właściwego czujnika stykowego i wartości temperatury i wilgotności względnej. 

Następnie dokonano eksportu danych zebranych w badanym okresie do dwóch plików \textit{csv}. Wynika to z tego, że jeden plik z całym zapisem zdarzeń zajmowałby około 160 MB. Próba pobrania go w całości zakończyła się zerwaniem połączenia. Zgodnie z informacją podaną w~dzienniku serwera Apache (ang. \textit{log}) błąd wynikał z ograniczenia czasu wykonywania skryptów PHP do 30 sekund. Ograniczenie to jest określone jako wartość zmiennej \linebreak\texttt{max{\_}execution{\_}time} znajdującej się w~pliku \texttt{etc{\textbackslash}php5{\textbackslash}apache2{\textbackslash}php.ini}. 

Poprawne działanie systemu w badanym okresie przedstawiono na wykresie na rysunku \ref{fig: test_pomiary}, obrazującym pomiary temperatury i wilgotności względnej z jednego z czujników. Pomiary były wykonywane w tym czasie z założoną częstotliwością 15 minut. Wszystkie wyniki pomiarów są~poprawne, nie ma wśród nich wartości pustych. Pełną tabelę z uzyskanymi wynikami pomiarów umieszczono w~załączniku w tabeli.

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.85\linewidth]{Wykres.png}
\caption{Wyniki pomiarów temperatury i wilgotności względnej w badanym okresie}
\label{fig: test_pomiary}
\end{center}
\end{figure}


\newpage
\section{Podsumowanie}
W ramach wykonanej pracy osiągnięty został postawiony cel -- zaprojektowanie i zrealizowanie systemu bezpieczeństwa z dostępem sieciowym. System ten pozwala na realizację monitoringu wizyjnego przy użyciu kamer USB dołączonych do platformy Raspberry Pi. Dodatkowo system obsługuje dołączone czujniki stykowe, które po zadziałaniu wyzwalają wykonanie zdjęcia kamerą, do której są przypisane. Mogą one prowadzić nadzór dostępu do budynku przez drzwi i okna. Do komputera Raspberry Pi dołączone są też czujniki temperatury i wilgotności, aby wykonywać pomiary tych wielkości, ważnych z punktu widzenia komfortu życia w domu. System jest skalowalny i może obsługiwać wiele kamer USB oraz czujników stykowych i czujników warunków środowiskowych dzięki użyciu multipleksera I2C oraz aktywnego rozgałęziacza USB. Dzięki dużym możliwościom zastosowanej platformy system może być w przyszłości dalej rozbudowywany o kolejne akcesoria, czujniki i funkcje programowe. Po dokonaniu przeglądu dostępnych na rynku kamer i czujników wybrano urządzenia spełniające postawione początkowo wymagania techniczne. Następnie wykonany został prototyp sprzętowy składający się z~dwóch kamer USB, czujników stykowych oraz czujników temperatury i wilgotności.

Obsługę kamer i czujników sprawuje program \texttt{nadzor.py} napisany w języku Python. Sprawdza on cyklicznie stan wyprowadzeń, do których dołączone są czujniki stykowe, wykonuje zdjęcia oraz wykonuje pomiary temperatury i wilgotności. W przypadku zadziałania czujnika stykowego program wykonuje zdjęcie kamerą, która jest do niego przypisana. Odpowiada to sytuacji np. otwarcia okna lub drzwi, na których jest zamontowany kontaktron. Po włączeniu odpowiedniego ustawienia w panelu administracyjnym program może również wysłać wiadomość e-mail z powiadomieniem o otwarciu czujnika. W załączniku wiadomości dołączone jest wówczas aktualnie wykonane zdjęcie.

Spełnione zostały wymogi funkcjonalne wobec systemu dotyczące dostępu do stanu systemu przez stronę WWW. Jest ona umieszczona na serwerze HTTP działającym na komputerze Raspberry Pi. Użytkownik musi dokonać uwierzytelnienia w serwerze, aby uzyskać dostęp do strony prezentującej wykonane zdjęcia, pomiary temperatury oraz stany czujników stykowych. Na stronie dostępne są aktualne i archiwalne zdjęcia i stany systemu. Możliwy jest też eksport listy stanów systemu do pliku w formacie \textit{csv}. Użytkownik ma również tutaj dostęp do ustawień systemu: włączenia powiadomień e-mail w przypadku zadziałania czujnika stykowego, zmiany nazw urządzeń w systemie oraz zmiany częstotliwości wykonywania zdjęć i~pomiarów.

W wykonanym systemie połączenia między czujnikami stykowymi oraz czujnikami warunków środowiskowych a platformą Raspberry Pi zostały zrealizowane na prototypowej płytce stykowej. Jest to niewątpliwe ułatwienie w szybkiej realizacji prototypu części sprzętowej systemu, jednak tak wykonane połączenia mogłyby być narażone w środowisku domowym w dłuższej perspektywie np. na poluzowanie przewodu, co spowodowałoby przerwanie połączenia i awarię. Z tego powodu przed umieszczeniem systemu w trybie ciągłego nadzoru będzie należało wykonać połączenia w sposób gwarantujący większą niezawodność (np. przez przylutowanie do płytki uniwersalnej). Z drugiej strony wybrany sposób wykonania połączeń w systemie ułatwił jednak jego skalowalność, ponieważ dołączenie nowego czujnika wymaga jedynie umieszczenia jego wyprowadzeń w wolnych otworach płytki stykowej i dołączenia przewodów. Kolejnym ograniczeniem wykonanego prototypu jest zasięg przewodów kamer USB. W obecnej wersji systemu zasięg przewodowych kamer jest ograniczony do kilku-kilkunastu metrów (przy użyciu aktywnego rozgałęziacza i przedłużacza USB). Nie był to wprawdzie element specyfikacji technicznej projektu, jednak może stać się to przeszkodą przy prowadzeniu monitoringu większych pomieszczeń lub miejsc znacznie oddalonych od siebie.

Ważnym problemem, który pojawił się w czasie tworzenia projektu była kwestia odpowiedniego przeprowadzenia pomiarów z użyciem czujnika temperatury i wilgotności typu Si7021 komunikującego się przez magistralę I2C. Trudność polegała na dobraniu odpowiedniej biblioteki w języku Python, która będzie udostępniała komendy magistrali I2C niezbędne do przeprowadzenia pomiaru zgodnie z sekwencją podaną w karcie katalogowej czujnika. Istotnym wnioskiem jest to, że komputer Raspberry Pi 3B nie pozwala na rozciąganie zegara (ang. \textit{clock stretching}) przez urządzenie podrzędne. Wykluczyło to jedną z dostępnych sekwencji pomiaru temperatury i wilgotności (\textit{No Hold Master Mode}). Wynika to z tego, że większość bibliotek korzysta z~wbudowanego w jądro systemu Linux sterownika protokołu SMBus będącego rozszerzeniem protokołu I2C. Ma on bardziej restrykcyjne wymagania czasowe dotyczące przeprowadzanych transakcji. Właściwym rozwiązaniem okazało się być użycie biblioteki \texttt{pigpio}, która posiada komendy pozwalające na przeprowadzenie pomiaru w trybie \textit{Hold Master Mode}.

Mimo potencjalnych problemów przy instalacji, wykonany prototyp sprzętowy systemu spełnia wszystkie postawione wymagania i może realizować monitoring wizyjny przy użyciu powszechnie dostępnych i atrakcyjnych cenowo kamer USB. Dzięki temu można zrealizować domowy system bezpieczeństwa, który dzięki niższej cenie będzie konkurencyjny wobec bardziej wyspecjalizowanych urządzeń, takich jak np. kamery IP. Dodatkową zaletą takiego systemu jest możliwość nadzoru otwarcia drzwi lub okien przy użyciu czujników stykowych oraz pomiaru temperatury i wilgotności względnej powietrza przez czujniki warunków środowiskowych. System może być też dalej rozbudowany o inne rodzaje czujników dwustanowych, stosowanych w systemach alarmowych, takich jak np. czujniki gazu i dymu, czy czujniki zalania wodą, praktycznie bez istotnych zmian w programie. Dzięki temu zaprojektowany system może pełnić nadzór bardziej kompleksowo niż tylko przez monitoring wizyjny.

\subsection{Kierunki dalszych prac}

Podstawowe funkcje panelu administracyjnego można dalej rozbudować tak, by zapewnić pełny dostęp do systemu i bazy danych przez interfejs użytkownika. Mogłoby to być zrealizowane przez dodatkowe funkcjonalności, takie jak panel dodawania i usuwania urządzeń. Dzięki temu dołączanie kolejnych czujników i kamer byłoby możliwe do zrealizowania przez użytkownika mającego małe umiejętności techniczne. Warto byłoby również wprowadzić podział użytkowników na kategorie różniące się uprawnieniami, np: administrator i użytkownik. Administrator miałby pełen dostęp do systemu i mógłby dokonywać w nim zmian, a użytkownik miałby jedynie dostęp do aktualnego stanu systemu i archiwalnych zdjęć wykonanych przez dołączone kamery USB.

Użycie komputera Raspberry Pi razem z systemem Linux zapewnia też możliwość lepszego zabezpieczenia systemu niż w przypadku użycia prostych platform, takich jak np. Arduino. Komputer Raspberry Pi dostarcza również moc obliczeniową, która mogłaby być użyta do zestawienia szyfrowanego połączenia (SSL/HTTPS) lub do wykrywania intruzów na wykonanych zdjęciach przy użyciu algorytmów detekcji ruchu. Możliwości tej platformy umożliwiają też wprowadzenie w przyszłości nadzoru ruchu w sieci domowej LAN i wykrywania najprostszych form ataków sieciowych. Powstałby wtedy kompleksowy system bezpieczeństwa, łączący funkcje tradycyjnych systemów alarmowych dodatkowo z kontrolą bezpieczeństwa sieciowego.



  

\newpage
\section{Bibliografia}
\begin{thebibliography}{9}

\bibitem{apache-auth}
\uppercase{Apache Software Foundation}, Authentication and Authorization, Dokumentacja serwera HTTP Apache [przeglądany 30 maja 2018].
Dostępny w: \url{https://httpd.apache.org/docs/2.4/howto/auth.html}

\bibitem{apache-password}
\uppercase{Apache Software Foundation}, Htpasswd - Manage user files for basic authentication, Dokumentacja serwera HTTP Apache [przeglądany 30 maja 2018].
Dostępny w: \url{https://httpd.apache.org/docs/2.4/programs/htpasswd.html}

\bibitem{zachorowania}
\uppercase{Arundel A. V., Sterling E. M., Biggin J. H. i Sterling T. D.}, Indirect health effects of relative humidity in indoor environments, \textit{Environmental Health Perspectives} 1986;65:351-361
Dostępny w: \url{https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1474709/}

\bibitem{sqlalchemy-session}
\uppercase{Bayer M.}, Session Basics, Dokumentacja SQLAlchemy [przeglądany 30 maja 2018].
Dostępny w: \url{http://docs.sqlalchemy.org/en/latest/orm/session_basics.html}

\bibitem{sqlalchemy-base}
\uppercase{Bayer M.}, Declarative API, Dokumentacja SQLAlchemy [przeglądany 2 czerwca 2018].
Dostępny w: \url{http://docs.sqlalchemy.org/en/latest/orm/extensions/declarative/api.html}

\bibitem{bb_black}
BeagleBoard: BeagleBoneBlack, \textit{Embedded Linux Wiki} [przeglądany 25 maja 2018].
Dostępny w: \url{https://elinux.org/Beagleboard:BeagleBoneBlack}

\bibitem{pikaday}
\uppercase{Bushell D., Rikkert R.}, Dokumentacja biblioteki Pikaday [przeglądany 2 czerwca 2018].
Dostępny w: \url{https://github.com/dbushell/Pikaday}

\bibitem{arduino-wlamania}
\uppercase{Cabaj K., Mazur G., Nosek M.}, \textit{Compromising an IoT device based on Harvard-architecture microntroller}, XLII Sympozjum Wilga-2018, 3-10 czerwca 2018.

\bibitem{porownanie_wiki}
Comparison of single-board computers, \textit{Wikipedia} [przeglądany 2 czerwca 2018].
Dostępny w: \url{https://en.wikipedia.org/w/index.php?title=Comparison_of_single-board_computers&oldid=843993327}

\bibitem{sql-injection}
\uppercase{Clarke J.}, SQL Injection Attacks and Defense, wyd. 2, Syngress, 2012, ISBN 978-1-59749-963-7  

\bibitem{inteligentny_dom}
DECHNIK M., MOSKWA S. Smart House – inteligentny budynek – idea przyszłości. Przegląd Elektrotechniczny, wrzesień 2017, DOI:10.15199/48.2017.09.01.
Dostępny w: \url{http://pe.org.pl/articles/2017/9/1.pdf}

\bibitem{komputer_świat}
\uppercase{Dziedzic K.}, Kamera IP w sieci. Stwórz prywatny monitoring [przeglądany 25 maja 2018].
Dostępny w: \url{http://www.komputerswiat.pl/poradniki/sprzet/kamery-internetowe/2015/07/kamera-ip-w-sieci.aspx}

\bibitem{http}
\uppercase{Fielding R., Reschke J.}, Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content, RFC7231, IETF, czerwiec 2014, DOI: 10.17487/RFC7231
Dostępny w: \url{https://tools.ietf.org/html/rfc7231}

\bibitem{http-auth}
\uppercase{Fielding R., Reschke J.}, Hypertext Transfer Protocol (HTTP/1.1): Authentication, RFC 7235, IETF, czerwiec 2014, DOI: 10.17487/RFC7235.
Dostępny w: \url{https://tools.ietf.org/html/rfc7235}

\bibitem{mime1}
\uppercase{Freed N., Borenstein N.}, Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies, RFC 2045, IETF, listopad 1996, DOI: 10.17487/RFC2045.
Dostępny w: \url{https://tools.ietf.org/html/rfc2045}

\bibitem{mime2}
\uppercase{Freed N., Borenstein N.}, Multipurpose Internet Mail Extensions (MIME) Part Two: Media Types, RFC 2046, IETF, listopad 1996, DOI: 10.17487/RFC2046.
Dostępny w: \url{https://tools.ietf.org/html/rfc2046}

\bibitem{ajax}
GARRETT J.J., Ajax: A New Approach to Web Applications [przeglądany: 6 czerwca 2018]. Dostępny w: \url{http://adaptivepath.org/ideas/ajax-new-approach-web-applications/}

\bibitem{th02}
HopeRF Electronic, Karta katalogowa czujnika temperatury i wilgotności TH02 [przeglądany 2 czerwca 2018].
Dostępny w: \url{http://www.hoperf.com/upload/sensor/TH02_V1.1.pdf}

\bibitem{i2c_read_device}
\uppercase{joan2937}, Dokumentacja funkcji \texttt{i2c{\_}read{\_}device()} [przeglądany 25 maja 2018].
Dostępny w: \url{http://abyz.me.uk/rpi/pigpio/python.html#i2c_read_device}

\bibitem{jquery_ajax}
jQuery Foundation, Dokumentacja funkcji jQuery.ajax() (przeglądany: 6 czerwca 2018). Dostępny w: \url{http://api.jquery.com/jquery.ajax/}

\bibitem{klimat}
\uppercase{Kostyrko K., Łobzowski A.}, \textit{Klimat. Pomiary i regulacja}, Agenda wydawnicza PAK, Warszawa, wrzesień 2002.

\bibitem{sht31}
\uppercase{Sensirion}, Karta katalogowa czujnika temperatury i wilgotności SHT31D [przeglądany 25 maja 2018].
Dostępny w: \url{https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/0_Datasheets/Humidity/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf}

\bibitem{dev_video}
SHANE H., Accessing the Video Device [przeglądany 6 czerwca 2018].
Dostępny w: \url{https://www.tldp.org/HOWTO/Webcam-HOWTO/dev-intro.html}

\bibitem{promise}
\uppercase{Mozilla Developer Network}, szopenkrk, Promise [przeglądany 30 maja 2018].
Dostępny w: \url{https://developer.mozilla.org/pl/docs/Web/JavaScript/Referencje/Obiekty/Promise}

\bibitem{async}
\uppercase{Mozilla Developer Network, Bab64, doubleOrt, freezy, hirokiky, jswisher, spygi} i in., async function [przeglądany 30 maja 2018].
Dostępny w: \url{https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function}

\bibitem{monitoring}
PRAUZNER, T. Systemy monitoringu w inteligentnym budynku. \textit{Prace Naukowe Akademii im. Jana Długosza w Częstochowie. Edukacja Techniczna i Informatyczna, 2012, 7}: 113--124.

\bibitem{python-mime}
\uppercase{Python Software Foundation}, Dokumentacja modułu Python email.mime [przeglądany 24 maja 2018].
Dostępny w: \url{https://docs.python.org/3/library/email.mime.html}

\bibitem{rpi_schematic}
\uppercase{Raspberry Pi Foundation}, Schematy peryferiów Raspberry Pi 3 Model B [przeglądany 24 maja 2018].
Dostępny w: \url{https://www.raspberrypi.org/documentation/hardware/raspberrypi/schematics/rpi_SCH_3b_1p2_reduced.pdf}

\bibitem{rpi}
\uppercase{Raspberry Pi Foundation}, Specyfikacja Raspberry Pi 3 Model B [przeglądany 24 maja 2018].
Dostępny w: \url{https://www.raspberrypi.org/products/raspberry-pi-3-model-b/}

\bibitem{content-disposition}
\uppercase{Reschke J.}, Use of the Content-Disposition Header Field in the Hypertext Transfer Protocol (HTTP), RFC 6266, IETF, czerwiec 2011, DOI: 10.17487/RFC6266.
Dostępny w: \url{https://tools.ietf.org/html/rfc6266}

\bibitem{czujnik_temp}
\uppercase{Silicon Labs}, Karta katalogowa czujnika temperatury i wilgotności Si7021 [przeglądany 24 maja 2018].
Dostępny w: \url{https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf}

\bibitem{kamery-ip}
SUMIŁA M., KASPRZYK Z., \textit{Koncepcja wykorzystania inteligentnych kamer IP do wspomagania nadzoru wizyjnego ITS.} Logistyka, kwiecień 2012. 
Dostępny w: \url{https://www.czasopismologistyka.pl/artykuly-naukowe/send/243-artykuly-na-plycie-cd-1/2931-artykul}

\bibitem{multiplekser}
\uppercase{Texas Instruments Inc.}, Karta katalogowa multipleksera TCA9548A [przeglądany 24 maja 2018].
Dostępny w: \url{http://www.ti.com/lit/ds/symlink/tca9548a.pdf}

\bibitem{smbus}
\uppercase{Torvalds L.}, Opis protokołu SMBus [przeglądany 20 maja 2018].
Dostępny w: \url{https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/i2c/smbus-protocol}

\bibitem{uikit}
\uppercase{YOOTheme GmbH}, Dokumentacja biblioteki UIKit [przeglądany 2 czerwca 2018].
Dostępny w: \url{https://getuikit.com/docs/introduction}

\end{thebibliography}

\newpage
\section{Załączniki}
% Please add the following required packages to your document preamble:
% \usepackage{longtable}
% Note: It may be necessary to compile the document several times to get a multi-page table to line up properly
\begin{longtable}[c]{ccc}
\caption{Wyniki pomiarów temperatury i wilgotności}
\label{pomiary}\\ \hline \noalign{\vskip 2mm}
Data i godzina pomiaru & Temperatura {[}$^\circ$C{]} & Wilgotność względna {[}\%RH{]} \\ \hline
\endhead
%
05.06.2018 00:00       & 27,70                & 42,72                          \\
05.06.2018 00:13       & 27,67                & 42,99                          \\
05.06.2018 00:27       & 27,65                & 43,12                          \\
05.06.2018 00:40       & 27,60                & 43,31                          \\
05.06.2018 00:54       & 27,57                & 43,77                          \\
05.06.2018 01:07       & 27,54                & 43,86                          \\
05.06.2018 01:21       & 27,56                & 44,08                          \\
05.06.2018 01:34       & 27,53                & 44,47                          \\
05.06.2018 01:48       & 27,54                & 44,67                          \\
05.06.2018 02:02       & 27,54                & 44,92                          \\
05.06.2018 02:15       & 27,57                & 44,94                          \\
05.06.2018 02:29       & 27,55                & 45,01                          \\
05.06.2018 02:42       & 27,55                & 45,09                          \\
05.06.2018 02:55       & 27,50                & 45,13                          \\
05.06.2018 03:09       & 27,47                & 45,15                          \\
05.06.2018 03:22       & 27,47                & 45,46                          \\
05.06.2018 03:36       & 27,40                & 45,38                          \\
05.06.2018 03:50       & 27,39                & 45,60                          \\
05.06.2018 04:03       & 27,36                & 45,87                          \\
05.06.2018 04:17       & 27,36                & 45,71                          \\
05.06.2018 04:30       & 27,29                & 45,49                          \\
05.06.2018 04:44       & 27,27                & 45,68                          \\
05.06.2018 04:57       & 27,26                & 45,62                          \\
05.06.2018 05:11       & 27,28                & 45,57                          \\
05.06.2018 05:24       & 27,26                & 45,33                          \\
05.06.2018 05:38       & 27,23                & 45,35                          \\
05.06.2018 05:51       & 27,23                & 45,18                          \\
05.06.2018 06:05       & 27,17                & 45,06                          \\
05.06.2018 06:18       & 27,15                & 45,08                          \\
05.06.2018 06:32       & 27,15                & 45,06                          \\
05.06.2018 06:46       & 27,11                & 44,95                          \\
05.06.2018 06:59       & 27,16                & 45,56                          \\
05.06.2018 07:13       & 27,22                & 45,56                          \\
05.06.2018 07:26       & 27,20                & 45,36                          \\
05.06.2018 07:40       & 27,19                & 44,72                          \\
05.06.2018 07:54       & 27,19                & 44,24                          \\
05.06.2018 08:07       & 27,19                & 44,06                          \\
05.06.2018 08:21       & 27,15                & 44,21                          \\
05.06.2018 08:34       & 27,16                & 44,22                          \\
05.06.2018 08:48       & 27,15                & 44,24                          \\
05.06.2018 09:01       & 27,20                & 44,35                          \\
05.06.2018 09:15       & 27,08                & 44,33                          \\
05.06.2018 09:28       & 27,00                & 44,53                          \\
05.06.2018 09:42       & 27,09                & 45,25                          \\
05.06.2018 09:56       & 27,11                & 45,11                          \\
05.06.2018 10:09       & 27,17                & 44,80                          \\
05.06.2018 10:23       & 27,20                & 44,29                          \\
05.06.2018 10:36       & 27,20                & 44,11                          \\
05.06.2018 10:49       & 27,22                & 43,86                          \\
05.06.2018 11:03       & 27,14                & 43,75                          \\
05.06.2018 11:17       & 27,16                & 43,87                          \\
05.06.2018 11:30       & 27,12                & 43,94                          \\
05.06.2018 11:44       & 27,20                & 44,08                          \\
05.06.2018 11:57       & 27,28                & 43,72                          \\
05.06.2018 12:11       & 27,34                & 43,32                          \\
05.06.2018 12:24       & 27,36                & 43,33                          \\
05.06.2018 12:38       & 27,35                & 43,26                          \\
05.06.2018 12:51       & 27,30                & 43,11                          \\
05.06.2018 13:05       & 27,36                & 43,21                          \\
05.06.2018 13:19       & 27,35                & 43,22                          \\
05.06.2018 13:33       & 27,38                & 43,47                          \\
05.06.2018 13:46       & 27,45                & 43,36                          \\
05.06.2018 13:59       & 27,42                & 43,08                          \\
05.06.2018 14:13       & 27,52                & 43,02                          \\
05.06.2018 14:27       & 27,57                & 42,53                          \\
05.06.2018 14:40       & 27,55                & 42,67                          \\
05.06.2018 14:54       & 27,57                & 43,09                          \\
05.06.2018 15:08       & 27,60                & 42,78                          \\
05.06.2018 15:21       & 27,61                & 42,48                          \\
05.06.2018 15:35       & 27,57                & 43,55                          \\
05.06.2018 15:48       & 27,23                & 45,30                          \\
05.06.2018 16:02       & 27,16                & 45,78                          \\
05.06.2018 16:16       & 27,01                & 46,00                          \\
05.06.2018 16:30       & 26,92                & 46,20                          \\
05.06.2018 16:43       & 26,76                & 45,42                          \\
05.06.2018 16:57       & 26,80                & 45,03                          \\
05.06.2018 17:10       & 26,79                & 44,66                          \\
05.06.2018 17:24       & 26,76                & 43,37                          \\
05.06.2018 17:38       & 26,77                & 42,64                          \\
05.06.2018 17:51       & 26,64                & 40,94                          \\
05.06.2018 18:05       & 26,62                & 40,78                          \\
05.06.2018 18:19       & 26,73                & 40,47                          \\
05.06.2018 18:32       & 26,87                & 39,89                          \\
05.06.2018 18:46       & 26,78                & 36,84                          \\
05.06.2018 19:00       & 26,68                & 36,46                          \\
05.06.2018 19:13       & 26,69                & 36,19                          \\
05.06.2018 19:27       & 26,62                & 36,71                          \\
05.06.2018 19:40       & 26,47                & 36,94                          \\
05.06.2018 19:54       & 26,22                & 35,87                          \\
05.06.2018 20:08       & 26,15                & 35,45                          \\
05.06.2018 20:22       & 26,07                & 35,19                          \\
05.06.2018 20:36       & 25,93                & 34,62                          \\
05.06.2018 20:50       & 25,82                & 34,16                          \\
05.06.2018 21:03       & 25,33                & 32,88                          \\
05.06.2018 21:17       & 25,14                & 32,69                          \\
05.06.2018 21:31       & 25,01                & 33,28                          \\
05.06.2018 21:44       & 24,91                & 34,05                          \\
05.06.2018 21:58       & 24,76                & 33,92                          \\
05.06.2018 22:12       & 24,65                & 33,91                          \\
05.06.2018 22:26       & 24,45                & 33,82                          \\
05.06.2018 22:40       & 24,30                & 33,51                          \\
05.06.2018 22:54       & 24,05                & 33,83                          \\
05.06.2018 23:07       & 24,19                & 34,30                          \\
05.06.2018 23:21       & 24,16                & 34,12                          \\
05.06.2018 23:35       & 24,13                & 34,51                          \\
05.06.2018 23:48       & 24,11                & 34,59                          \\
06.06.2018 00:00       & 24,04                & 34,33                          \\
06.06.2018 00:13       & 23,87                & 33,97                          \\
06.06.2018 00:27       & 23,91                & 34,16                          \\
06.06.2018 00:41       & 23,87                & 33,97                          \\
06.06.2018 00:55       & 23,88                & 34,07                          \\
06.06.2018 01:08       & 23,95                & 34,07                          \\
06.06.2018 01:22       & 23,99                & 33,52                          \\
06.06.2018 01:36       & 23,99                & 33,18                          \\
06.06.2018 01:50       & 23,92                & 32,78                          \\
06.06.2018 02:03       & 23,98                & 33,06                          \\
06.06.2018 02:17       & 24,11                & 33,24                          \\
06.06.2018 02:31       & 24,02                & 32,78                          \\
06.06.2018 02:45       & 23,96                & 31,88                          \\
06.06.2018 02:59       & 24,04                & 32,17                          \\
06.06.2018 03:12       & 24,14                & 32,30                          \\
06.06.2018 03:26       & 24,24                & 32,04                          \\
06.06.2018 03:40       & 24,27                & 31,72                          \\
06.06.2018 03:54       & 24,18                & 31,01                          \\
06.06.2018 04:07       & 24,18                & 31,08                          \\
06.06.2018 04:21       & 24,26                & 31,27                          \\
06.06.2018 04:35       & 24,29                & 31,10                          \\
06.06.2018 04:49       & 24,39                & 31,98                          \\
06.06.2018 05:03       & 24,31                & 31,36                          \\
06.06.2018 05:17       & 24,29                & 30,77                          \\
06.06.2018 05:31       & 24,29                & 30,30                          \\
06.06.2018 05:44       & 24,32                & 29,63                          \\
06.06.2018 05:58       & 24,23                & 29,03                          \\
06.06.2018 06:12       & 24,20                & 28,94                          \\
06.06.2018 06:26       & 24,10                & 28,53                          \\
06.06.2018 06:40       & 24,12                & 28,78                          \\
06.06.2018 06:54       & 24,01                & 28,01                          \\
06.06.2018 07:08       & 23,98                & 28,27                          \\
06.06.2018 07:22       & 24,18                & 29,05                          \\
06.06.2018 07:36       & 24,35                & 28,76                          \\
06.06.2018 07:50       & 24,34                & 28,28                          \\
06.06.2018 08:04       & 24,45                & 29,69                          \\
06.06.2018 08:18       & 24,53                & 29,91                          \\
06.06.2018 08:32       & 24,59                & 29,37                          \\
06.06.2018 08:46       & 24,64                & 27,35                          \\
06.06.2018 09:00       & 24,59                & 26,87                          \\
06.06.2018 09:13       & 24,56                & 26,89                          \\
06.06.2018 09:27       & 24,50                & 26,02                          \\
06.06.2018 09:41       & 24,45                & 25,37                          \\
06.06.2018 09:55       & 24,34                & 24,09                          \\
06.06.2018 10:09       & 24,32                & 23,92                          \\
06.06.2018 10:23       & 24,35                & 23,35                          \\
06.06.2018 10:37       & 24,30                & 22,57                          \\
06.06.2018 10:51       & 24,30                & 22,13                          \\
06.06.2018 11:05       & 24,19                & 21,46                          \\
06.06.2018 11:19       & 24,24                & 21,78                          \\
06.06.2018 11:33       & 24,15                & 21,33                          \\
06.06.2018 11:47       & 24,27                & 21,65                          \\
06.06.2018 12:01       & 24,30                & 21,49                          \\
06.06.2018 12:15       & 24,29                & 21,21                          \\
06.06.2018 12:29       & 24,33                & 21,18                          \\
06.06.2018 12:43       & 24,30                & 21,12                          \\
06.06.2018 12:57       & 24,39                & 21,02                          \\
06.06.2018 13:11       & 24,38                & 20,74                          \\
06.06.2018 13:25       & 24,39                & 20,54                          \\
06.06.2018 13:38       & 24,39                & 20,62                          \\
06.06.2018 13:52       & 24,43                & 20,66                          \\
06.06.2018 14:06       & 24,54                & 20,67                          \\
06.06.2018 14:21       & 24,65                & 20,99                          \\
06.06.2018 14:35       & 24,77                & 21,16                          \\
06.06.2018 14:49       & 24,85                & 21,21                          \\
06.06.2018 15:02       & 24,89                & 21,29                          \\
06.06.2018 15:16       & 24,94                & 21,27                          \\
06.06.2018 15:30       & 24,94                & 21,20                          \\
06.06.2018 15:44       & 25,01                & 21,28                          \\
06.06.2018 15:59       & 24,91                & 21,76                          \\
06.06.2018 16:13       & 24,89                & 21,63                          \\
06.06.2018 16:27       & 24,98                & 21,81                          \\
06.06.2018 16:41       & 24,97                & 21,59                          \\
06.06.2018 16:55       & 25,13                & 21,65                          \\
06.06.2018 17:09       & 25,14                & 21,52                          \\
06.06.2018 17:23       & 25,19                & 21,68                          \\
06.06.2018 17:37       & 25,32                & 22,13                          \\
06.06.2018 17:51       & 25,33                & 22,35                          \\
06.06.2018 18:05       & 25,95                & 21,90                          \\
06.06.2018 18:19       & 25,71                & 22,94                          \\
06.06.2018 18:33       & 26,75                & 22,03                          \\
06.06.2018 18:47       & 25,63                & 22,97                          \\
06.06.2018 19:01       & 25,59                & 23,33                          \\
06.06.2018 19:15       & 25,47                & 23,24                          \\
06.06.2018 19:29       & 25,38                & 23,06                          \\
06.06.2018 19:43       & 25,29                & 22,94                          \\
06.06.2018 19:58       & 25,10                & 22,87                          \\
06.06.2018 20:11       & 25,00                & 22,95                          \\
06.06.2018 20:25       & 24,91                & 22,92                          \\
06.06.2018 20:39       & 24,86                & 23,10                          \\
06.06.2018 20:53       & 24,85                & 23,42                          \\
06.06.2018 21:07       & 24,75                & 24,12                          \\
06.06.2018 21:21       & 24,71                & 24,22                          \\
06.06.2018 21:35       & 24,63                & 24,41                          \\
06.06.2018 21:49       & 24,59                & 24,32                          \\
06.06.2018 22:03       & 24,56                & 24,21                          \\
06.06.2018 22:17       & 24,59                & 24,72                          \\
06.06.2018 22:32       & 24,60                & 24,92                          \\
06.06.2018 22:46       & 24,61                & 25,46                          \\
06.06.2018 23:00       & 24,62                & 25,74                          \\
06.06.2018 23:14       & 24,62                & 26,01                          \\
06.06.2018 23:28       & 24,58                & 26,52                          \\
06.06.2018 23:41       & 24,57                & 26,74                          \\
06.06.2018 23:56       & 24,55                & 27,22                          \\
07.06.2018 00:10       & 24,54                & 27,44                          \\
07.06.2018 00:24       & 24,56                & 27,64                          \\
07.06.2018 00:38       & 24,53                & 28,05                          \\
07.06.2018 00:52       & 24,49                & 28,21                          \\
07.06.2018 01:06       & 24,45                & 28,62                          \\
07.06.2018 01:20       & 24,44                & 28,82                          \\
07.06.2018 01:34       & 24,45                & 29,01                          \\
07.06.2018 01:48       & 24,40                & 29,37                          \\
07.06.2018 02:02       & 24,40                & 29,58                          \\
07.06.2018 02:16       & 24,35                & 29,92                          \\
07.06.2018 02:30       & 24,34                & 30,12                          \\
07.06.2018 02:44       & 24,30                & 30,29                          \\
07.06.2018 02:58       & 24,29                & 30,59                          \\
07.06.2018 03:12       & 24,27                & 30,73                          \\
07.06.2018 03:26       & 24,24                & 30,98                          \\
07.06.2018 03:40       & 24,20                & 31,14                          \\
07.06.2018 03:55       & 24,19                & 31,22                          \\
07.06.2018 04:09       & 24,16                & 31,43                          \\
07.06.2018 04:23       & 24,15                & 31,50                          \\
07.06.2018 04:37       & 24,12                & 31,71                          \\
07.06.2018 04:51       & 24,10                & 31,79                          \\
07.06.2018 05:05       & 24,09                & 31,85                          \\
07.06.2018 05:20       & 24,10                & 31,95                          \\
07.06.2018 05:34       & 24,11                & 31,95                          \\
07.06.2018 05:48       & 24,17                & 31,96                          \\
07.06.2018 06:02       & 24,18                & 32,04                          \\
07.06.2018 06:17       & 24,25                & 32,07                          \\
07.06.2018 06:31       & 24,24                & 32,14                          \\
07.06.2018 06:45       & 24,28                & 32,21                          \\
07.06.2018 06:59       & 24,32                & 32,47                          \\
07.06.2018 07:13       & 24,34                & 32,56                          \\
07.06.2018 07:27       & 24,38                & 32,55                          \\
07.06.2018 07:41       & 24,41                & 32,53                          \\
07.06.2018 07:55       & 24,44                & 33,79                          \\
07.06.2018 08:09       & 24,50                & 34,00                          \\
07.06.2018 08:23       & 24,54                & 33,98                          \\
07.06.2018 08:37       & 24,58                & 33,67                          \\
07.06.2018 08:51       & 24,58                & 33,79                          \\
07.06.2018 09:05       & 24,62                & 33,36                         
\end{longtable}


\end{document}
